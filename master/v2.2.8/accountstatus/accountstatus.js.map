{"version":3,"sources":["../../../../src/accountstatus/accountstatus.es6"],"names":["reposition_dialogs","min","parent","each","top","css","replace","animate","is_shown","AccountStatus","addEventListeners","liveapi","events","on","onLogin","bind","$ele","is","slideUp","response","authorize","is_virtual","getStatus","account_status","website_status","get_settings","financial_assessment","mt5_account","tc_accepted","financial_assessment_submitted","is_mlt","test","landing_company_name","is_mf","is_cr","has_mt5_account","mt5_login_list","length","is_authenticated","get_account_status","prompt_client_to_authenticate","terms_conditions_version","client_tnc_status","risk_classification","status","indexOf","checkStatus","Promise","all","send","cached","get_financial_assessment","_this","openBinaryUrl","url","binary_url","getBinaryUrl","win","window","open","model","excluded_until","message","i18n","is_valid","local_storage","get","callback","tc","init","risk","tax","currency","authenticate","unwelcome","invalid_obj","_","find","obj","html","slideDown","recheckStatus","auth"],"mappings":"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","file":"accountstatus.js","sourcesContent":["import $ from 'jquery';\r\nimport liveapi from '../websockets/binary_websockets';\r\nimport _ from 'lodash';\r\nimport tc from '../tc/tc';\r\nimport '../common/util';\r\n\r\nconst reposition_dialogs = (min) => {\r\n  $('.webtrader-dialog').parent().each(function () {\r\n    const top = $(this).css('top').replace('px', '') * 1;\r\n    if (top <= min) {\r\n      $(this).animate({ top: `${min}px` }, 300);\r\n    }\r\n  });\r\n};\r\nlet is_shown = false;\r\n\r\nclass AccountStatus {\r\n\r\n  constructor(addEventListeners) {\r\n    // Initiating account check on login.\r\n        liveapi.events.on('login', this.onLogin.bind(this));\r\n        // liveapi.events.on('switch_account', onLogin);\r\n\r\n        // Hide msg bar on logout.\r\n         liveapi.events.on('reset_accountstatus', _ => {\r\n             const $ele = $('#msg-notification');\r\n             $ele.is(':visible') && $ele.slideUp(500);\r\n             is_shown = false;\r\n         });\r\n  }\r\n  async onLogin (response) {\r\n    const $ele = $('#msg-notification');\r\n    if (+response.authorize.is_virtual === 1) {\r\n      $ele.is(':visible') && $ele.slideUp(500);\r\n      is_shown = false;\r\n      reposition_dialogs(115);\r\n      return;\r\n    }\r\n\r\n    const [account_status, website_status, get_settings,\r\n      financial_assessment, mt5_account] = await this.getStatus(response.authorize);\r\n    this.tc_accepted = false;\r\n    this.financial_assessment_submitted = true;\r\n    this.is_mlt = /^malta$/gi.test(response.authorize.landing_company_name);\r\n    this.is_mf = /^maltainvest$/gi.test(response.authorize.landing_company_name);\r\n    this.is_cr = /^svg|costarica$/gi.test(response.authorize.landing_company_name);\r\n    this.has_mt5_account = mt5_account.mt5_login_list.length > 0;\r\n    this.is_authenticated = !+account_status.get_account_status.prompt_client_to_authenticate;\r\n    // Check whether the user has accepted the T&C.\r\n    if (website_status && website_status.website_status && get_settings && get_settings.get_settings) {\r\n      this.tc_accepted = website_status.website_status.terms_conditions_version === get_settings.get_settings.client_tnc_status;\r\n    }\r\n\r\n    // Check whether the high risk clients have submitted the financial_assessment form.\r\n    if (account_status.get_account_status.risk_classification === 'high' || this.is_mf) {\r\n      this.financial_assessment_submitted = account_status.get_account_status.status.indexOf('financial_assessment_not_complete') == -1;\r\n    }\r\n\r\n    this.checkStatus(response.authorize, account_status.get_account_status.status);\r\n  }\r\n\r\n  getStatus() {\r\n    // Getting account status, website status, account settings and financial assessment.\r\n    return Promise.all([\r\n      liveapi.send({ get_account_status: 1 }),\r\n      liveapi.cached.send({ website_status: 1 }),\r\n      liveapi.cached.send({ 'get_settings': 1 }),\r\n      liveapi.cached.send({ get_financial_assessment: 1 }),\r\n      liveapi.send({ mt5_login_list: 1 })\r\n    ]);\r\n  }\r\n\r\n  checkStatus(authorize, status) {\r\n    const $ele = $('#msg-notification');\r\n    const _this = this;\r\n\r\n    const openBinaryUrl = (url) => {\r\n      const binary_url = getBinaryUrl(url);\r\n      const win = window.open(binary_url, '_blank');\r\n    };\r\n\r\n    const model = {\r\n      excluded_until: {\r\n        message: 'Your account is restricted. Kindly [_1]contact customer support[_2] for assistance.'\r\n        .i18n().replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => local_storage.get('excluded') == false,\r\n        callback: () => openBinaryUrl('contact'),\r\n      },\r\n      tc: {\r\n        message: 'Please [_1]accept the updated Terms and Conditions[_2] to lift your withdrawal and trading limits.'\r\n          .i18n().replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => _this.tc_accepted,\r\n        callback: tc.init\r\n      },\r\n      risk: {\r\n        message: 'Please complete the [_1]financial assessment form[_2] to lift your withdrawal and trading limits.'\r\n          .i18n().replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => _this.financial_assessment_submitted,\r\n        callback: () => openBinaryUrl('user/settings/assessmentws'),\r\n      },\r\n      tax: {\r\n        message: 'Please [_1]complete your account profile[_2] to lift your withdrawal and trading limits.'\r\n          .i18n().replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => !_this.is_mf || /crs_tin_information/.test(status),\r\n        callback: () => openBinaryUrl('user/settings/detailsws'),\r\n      },\r\n      currency: {\r\n        message: 'Please set the [_1]currency[_2] of your account'\r\n          .i18n().replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => local_storage.get('currency'),\r\n        callback: () => openBinaryUrl('user/set-currency'),\r\n      },\r\n      authenticate: {\r\n        message: '[_1]Authenticate your account[_2] now to take full advantage of all withdrawal options available.'.i18n()\r\n          .replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => _this.is_authenticated,\r\n        callback: () => openBinaryUrl('user/authenticate'),\r\n      },\r\n      unwelcome: {\r\n        message: 'Your account is restricted. Kindly [_1]contact customer support[_2] for assistance.'\r\n          .i18n().replace('[_1]', '<a href=\"#\">').replace('[_2]', '</a>'),\r\n        is_valid: _ => !/(unwelcome|(cashier|withdrawal)_locked)/.test(status),\r\n        callback: () => openBinaryUrl('contact'),\r\n      }\r\n    }\r\n    // Getting the invalid account status.\r\n    const invalid_obj = _.find(model, obj => !obj.is_valid());\r\n    if (invalid_obj) {\r\n      // Show message\r\n      $ele.html(invalid_obj.message);\r\n      // bind click event to open specific dialogs with instructions.\r\n      $ele.find('a').on('click', invalid_obj.callback);\r\n      $ele.slideDown(500);\r\n      reposition_dialogs(140);\r\n      is_shown = true;\r\n    } else {\r\n      $ele.is(':visible') && $ele.slideUp(500);\r\n      reposition_dialogs(115);\r\n      is_shown = false;\r\n    }\r\n  }\r\n}\r\n\r\nexport const init = new AccountStatus();\r\n\r\nexport default {\r\n  init,\r\n  recheckStatus: (auth) => init.onLogin({authorize: auth}),\r\n  is_shown: () => is_shown\r\n}\r\n"]}