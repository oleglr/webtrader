{"version":3,"sources":["../../../../src/viewtransaction/viewTransaction.es6"],"names":["ChartSettings","require","open_dialogs","NOTE_TEXT","EXPIRED","i18n","MARKET_RATE","NO_RESALE","FINISHED","market_data_disruption_win","showMarketDataDisruptionWindow","moveToTop","market_disrupt_msg","root","windows","createBlankWindow","title","height","resizable","collapsable","minimizable","maximizable","destroy","dialog","remove","window","dd","initChart","state","options","data","type","display_decimals","history","times","prices","i","length","push","Math","max","toString","substring","indexOf","candles","map","c","epoch","open","high","low","close","el","find","CHART_LABELS","getChartLabels","proposal_open_contract","entry_tick_time","date_start","zone_start","chart_options","credits","href","text","chart","renderTo","backgroundColor","width","marginLeft","marginRight","subtitle","getLabelEl","useHTML","tooltip","formatter","spot","addComma","y","spot_time","moment","utc","x","format","series","name","xAxis","categories","startOnTick","endOnTick","min","labels","overflow","yAxis","align","value","zIndex","zoneAxis","zones","color","exporting","enabled","enableImages","legend","navigator","plotOptions","line","marker","radius","candlestick","lineColor","upColor","upLineColor","shadow","rangeSelector","Highcharts","Chart","addPlotLineX","addPlotLine","id","dashStyle","addPlotLineY","init","contract_id","transaction_id","Promise","resolve","reject","liveapi","send","then","proposal","underlying","undefined","shortcode","init_dialog","catch","err","console","error","handleError","message","$","growl","forget","echo_req","subscribe","updateIndicative","contract","updateState","drawChart","contract_has_finished","status","onContractFinished","updateStateSell","handleForwardStarting","manualReflow","sell_time","is_path_dependent","exit_tick_time","parseInt","pip_value","getSymbolPipValue","pip","is_sold_before_expiry","date_expiry","current_spot","current_spot_time","bid_price","entry_tick","is_sold","exit_tick","sell_price","is_valid_to_sell","barrier","high_barrier","low_barrier","note","makeNote","sell","split","unit","cent","constract_is_forward_starting","is_forward_starting","fwd_starting","drawSparkline","drawSpots","drawXLines","drawBarriers","drawZones","drawZone","label","zone_idx","hasLabel","tick_count","drawSpot","series_spot","getMarkerSettings","update","drawXLine","line_time","drawEndTime","drawPurchaseTime","purchase_time","is_ended","sell_at_market_enabled","validation_error","is_expired","bid_prices","shift","html","initState","transWin","display_name","minWidth","minHeight","view","unbind","events","off","on_proposal_open_contract_cb","onclose","resize","rv","bind","sellAtMarket","price","buy_price","longcode","currency","state_confirm","sold_for","return_percent","toFixed","balance","balance_after","$html","after","view_confirm","route","loading","added_labels","includes","h","container","setSize","hasUserSize","showLoading","hideLoading","is_settleable","is_sold_at_market","isLookback","Lookback","contract_type","lb_formula","formula","multiplier","formatPrice","setupChart","getContractData","onProposalOpenContract","on","is_different_stream","updateLiveChart","granularity","key","chartingRequestMap","keyFor","handleChartingRequestMap","on_tick_cb","on_candles_cb","clean_up_done","cleanUp","handleTick","handleCandle","req","makeChartingRequestMapRequest","register","symbol","style","tick","addTickToChart","addPoint","quote","data_key","ohlc","last","open_time","unregister","removeBarriers","addBarrierToChart","removePlotLine","duration","unix","makeGranularity","margin","makeTimeMargin","tick_history_request","makeTickHistoryRequest","onTickHistorySuccess","onTickHistoryError","start","contract_has_not_started","end","request","adjust_start_time","ticks_history","count","makeChartOptions"],"mappings":"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","file":"viewTransaction.js","sourcesContent":["ï»¿import $ from 'jquery';\r\nimport windows from 'windows/windows';\r\nimport liveapi from 'websockets/binary_websockets';\r\nimport chartingRequestMap from 'charts/chartingRequestMap';\r\nimport rv from 'common/rivetsExtra';\r\nimport moment from 'moment';\r\nimport 'common/util';\r\nimport * as ChartSettings from '../charts/chartSettings';\r\nimport Lookback from 'trade/lookback';\r\nrequire(['css!viewtransaction/viewTransaction.css']);\r\nrequire(['text!viewtransaction/viewTransaction.html']);\r\n\r\nconst open_dialogs = {};\r\nconst NOTE_TEXT = {\r\n  EXPIRED: 'This contract has expired'.i18n(),\r\n  MARKET_RATE: 'Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.'.i18n(),\r\n  NO_RESALE: 'Resale of this contract is not offered'.i18n(),\r\n  FINISHED: 'This contract has expired'.i18n(),\r\n};\r\n\r\nlet market_data_disruption_win = null;\r\nconst showMarketDataDisruptionWindow = () => {\r\n   if (market_data_disruption_win) {\r\n      market_data_disruption_win.moveToTop();\r\n      return;\r\n   }\r\n   const market_disrupt_msg = 'There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.'.i18n();\r\n   const root = $('<div class=\"data-disruption-dialog\">' + market_disrupt_msg + '</div>');\r\n\r\n   market_data_disruption_win = windows.createBlankWindow(root, {\r\n      title: ' There was an error '.i18n(),\r\n      height: 200,\r\n      resizable:false,\r\n      collapsable:false,\r\n      minimizable: false,\r\n      maximizable: false,\r\n      destroy: () => {\r\n         market_data_disruption_win && market_data_disruption_win.dialog('destroy').remove();\r\n         market_data_disruption_win = null;\r\n      },\r\n      'data-authorized': 'true'\r\n   });\r\n\r\n   market_data_disruption_win.dialog('open');\r\n   window.dd = market_data_disruption_win;\r\n};\r\n\r\nconst initChart = (root, state, options) => {\r\n   let data = [];\r\n   let type = '';\r\n   let display_decimals = 3;\r\n\r\n   if (options.history) {\r\n      type = 'line';\r\n      const { history } = options;\r\n      const { times, prices } = history;\r\n\r\n      for (let i = 0; i < times.length; ++i) {\r\n         data.push([times[i] * 1000, prices[i] * 1]);\r\n         display_decimals = Math.max(display_decimals, prices[i].toString().substring(prices[i].toString().indexOf('.') + 1).length);\r\n      }\r\n   }\r\n\r\n   if (options.candles) {\r\n      type = 'candlestick';\r\n      data = options.candles.map((c) => [c.epoch * 1000, c.open * 1, c.high * 1, c.low * 1, c.close * 1]);\r\n   }\r\n\r\n   const { title } = options;\r\n   const el = root.find('.transaction-chart')[0];\r\n   const CHART_LABELS = ChartSettings.getChartLabels(state.proposal_open_contract);\r\n   const { entry_tick_time, date_start } = state.proposal_open_contract;\r\n   const zone_start = entry_tick_time || date_start;\r\n\r\n   const chart_options = {\r\n      credits: { href: '#', text: '' },\r\n      chart: {\r\n         type: 'line',\r\n         renderTo: el,\r\n         backgroundColor: null, /* make background transparent */\r\n         width: 0,\r\n         height: 0,\r\n         marginLeft: 65,\r\n         marginRight:20\r\n      },\r\n      title: { text: '' },\r\n      subtitle: {\r\n        text: ChartSettings.getLabelEl(CHART_LABELS),\r\n        useHTML: true,\r\n      },\r\n      tooltip: {\r\n         useHTML: true,\r\n         formatter() {\r\n            const spot = addComma(this.y, display_decimals);\r\n            const spot_time = moment.utc(this.x).format('dddd, MMM D, HH:mm:ss');\r\n            return `<div class='tooltip-body'>${spot_time} GMT<br/>${this.series.name} ${spot}</div>`;\r\n        },\r\n      },\r\n      xAxis: {\r\n         type: 'datetime',\r\n         categories:null,\r\n         startOnTick: false,\r\n         endOnTick: false,\r\n         min: data.length ? data[0][0] : null,\r\n         max: data.length ? data[data.length - 1][0] : null,\r\n         labels: { overflow:\"justify\", format:\"{value:%H:%M:%S}\" },\r\n      },\r\n      yAxis: {\r\n        labels: {\r\n          align: 'left',\r\n          x: -65,\r\n          y: -2,\r\n          formatter() {\r\n            return addComma(this.value, display_decimals);\r\n          },\r\n        },\r\n         title: '',\r\n      },\r\n      series: [{\r\n         name: title,\r\n         data: data,\r\n         type: type,\r\n         zIndex: 10,\r\n         zoneAxis: 'x',\r\n         // zones are used to display color of the line\r\n         zones:[{\r\n             // make the line grey until it reaches entry time or zone_start time if entry spot time is not yet known\r\n             value: zone_start ? +zone_start * 1000 : '',\r\n             color: '#ccc',\r\n         }, {\r\n             // make the line default color until exit time is reached\r\n             color: '',\r\n         }, {\r\n             // make the line grey again after trade ended\r\n             color: '#ccc',\r\n         }],\r\n      }],\r\n      exporting: { enabled: false, enableImages: false},\r\n      legend: { enabled: false},\r\n      navigator: { enabled: true },\r\n      plotOptions: {\r\n         line: {\r\n            marker: { radius: 2 }\r\n         },\r\n         candlestick: {\r\n            lineColor: 'black',\r\n            color: 'red',\r\n            upColor: 'green',\r\n            upLineColor: 'black',\r\n            shadow: true\r\n         },\r\n      },\r\n      rangeSelector: { enabled: false },\r\n   };\r\n   const chart = new Highcharts.Chart(chart_options);\r\n\r\n   chart.addPlotLineX = (options) => {\r\n      chart.xAxis[0].addPlotLine({\r\n         value: options.value,\r\n         id: options.id || options.value,\r\n         color: options.color || '#e98024',\r\n         zIndex: 0,\r\n         width: options.width || 2,\r\n         dashStyle: options.dashStyle,\r\n      });\r\n   };\r\n\r\n   chart.addPlotLineY = (options) => {\r\n      chart.yAxis[0].addPlotLine({\r\n         id: options.id,\r\n         value: options.value,\r\n         color: options.color || 'green',\r\n         zIndex: 0,\r\n         width: 2,\r\n         dashStyle: options.dashStyle,\r\n      });\r\n   };\r\n   return el.chart = chart;\r\n};\r\n\r\nexport const init = (contract_id, transaction_id) => {\r\n   return new Promise((resolve, reject) => {\r\n      if (open_dialogs[transaction_id]) {\r\n         open_dialogs[transaction_id].moveToTop();\r\n         resolve();\r\n         return;\r\n      }\r\n      liveapi.send({proposal_open_contract: 1, contract_id})\r\n        .then((data) => {\r\n            const proposal = data.proposal_open_contract;\r\n            /* check for market data disruption error */\r\n            if (proposal.underlying === undefined && proposal.shortcode === undefined) {\r\n               showMarketDataDisruptionWindow(proposal);\r\n               return;\r\n            }\r\n            proposal.transaction_id = transaction_id;\r\n            init_dialog(proposal);\r\n            resolve();\r\n         })\r\n         .catch((err) => {\r\n            console.error(err);\r\n            reject(err);\r\n         });\r\n   });\r\n};\r\n\r\nconst handleError = (message) => {\r\n  $.growl.error({ message });\r\n  liveapi.proposal_open_contract.forget(data.echo_req.contract_id);\r\n  liveapi.proposal_open_contract.subscribe(data.echo_req.contract_id);\r\n};\r\n\r\nconst updateIndicative = (data, state) => {\r\n  const contract = data.proposal_open_contract;\r\n  updateState(contract, state);\r\n  drawChart(contract, state);\r\n\r\n  const contract_has_finished = contract.status !== 'open';\r\n  if (contract_has_finished) {\r\n    onContractFinished(state);\r\n    return;\r\n  }\r\n\r\n  updateStateSell();\r\n  handleForwardStarting();\r\n  state.chart.manualReflow();\r\n\r\n  function updateState(contract, state) {\r\n    const sell_time = contract.is_path_dependent && contract.status !== 'sold' ? contract.exit_tick_time : parseInt(contract.sell_time);\r\n    const pip_value = getSymbolPipValue(contract.underlying);\r\n\r\n    // note: cannot use spread operator - rivets.js 2-way data-binding breaks if new object\r\n    state.proposal_open_contract.pip = pip_value;\r\n    state.proposal_open_contract.is_sold_before_expiry = sell_time < contract.date_expiry;\r\n    state.proposal_open_contract.current_spot = contract.current_spot;\r\n    state.proposal_open_contract.current_spot_time = contract.current_spot_time;\r\n    state.proposal_open_contract.bid_price = contract.bid_price;\r\n    state.proposal_open_contract.entry_tick = contract.entry_tick;\r\n    state.proposal_open_contract.entry_tick_time = contract.entry_tick_time;\r\n    state.proposal_open_contract.status = contract.status;\r\n    state.proposal_open_contract.is_sold = contract.is_sold;\r\n    state.proposal_open_contract.exit_tick = contract.exit_tick;\r\n    state.proposal_open_contract.exit_tick_time = contract.exit_tick_time;\r\n    state.proposal_open_contract.date_expiry = contract.date_expiry;\r\n    state.proposal_open_contract.sell_price = contract.sell_price;\r\n    state.proposal_open_contract.is_valid_to_sell = contract.is_valid_to_sell;\r\n    state.proposal_open_contract.barrier = contract.barrier;\r\n    state.proposal_open_contract.high_barrier = contract.high_barrier;\r\n    state.proposal_open_contract.low_barrier = contract.low_barrier;\r\n\r\n    state.note = makeNote(contract);\r\n  }\r\n\r\n  function updateStateSell() {\r\n    if (contract.bid_price) {\r\n      state.sell.bid_price.value = contract.bid_price;\r\n      [state.sell.bid_price.unit, state.sell.bid_price.cent] = contract.bid_price.toString().split(/[\\.,]+/);\r\n    }\r\n  }\r\n\r\n  function handleForwardStarting() {\r\n    const constract_is_forward_starting = contract.is_forward_starting && +contract.date_start > +contract.current_spot_time;\r\n    if (constract_is_forward_starting) {\r\n      state.fwd_starting = '* Contract has not started yet'.i18n();\r\n      return;\r\n    }\r\n    state.fwd_starting = '';\r\n  }\r\n};\r\n\r\nfunction drawChart(contract, state) {\r\n  drawSparkline(contract, state);\r\n\r\n  const { chart } = state.chart;\r\n  if (!chart) return;\r\n\r\n  drawSpots(contract, state, chart);\r\n  drawXLines(contract, state, chart);\r\n  drawBarriers(contract, state);\r\n  drawZones(contract, state, chart);\r\n}\r\n\r\nfunction drawZones(contract, state, chart) {\r\n  const { entry_tick_time, exit_tick_time, date_expiry, sell_time } = contract;\r\n  const { is_sold_before_expiry } = state.proposal_open_contract;\r\n\r\n  drawZone({ spot_time: entry_tick_time, label: 'entry_zone', zone_idx: 0 });\r\n\r\n  if (is_sold_before_expiry) {\r\n    drawZone({ spot_time: exit_tick_time || sell_time, label: 'exit_zone', zone_idx: 1 });\r\n  }\r\n  drawZone({ spot_time: exit_tick_time || date_expiry, label: 'exit_zone', zone_idx: 1 });\r\n\r\n  function drawZone({spot_time, label, zone_idx}) {\r\n    if (!spot_time || state.chart.hasLabel(label)) return;\r\n\r\n    chart.series[0].zones[zone_idx].value = (+spot_time * 1000);\r\n  }\r\n}\r\n\r\nfunction drawSpots(contract, state, chart) {\r\n  const { entry_tick_time, exit_tick_time, tick_count, is_path_dependent } = contract;\r\n  const { is_sold_before_expiry } = state.proposal_open_contract;\r\n\r\n  if (tick_count) return; // tick contracts = chart should not have entry/exit spots\r\n\r\n  if (entry_tick_time) {\r\n    drawSpot({ spot_time: entry_tick_time, label: 'entry_tick_time', color: 'white' });\r\n  }\r\n\r\n  if (is_path_dependent && exit_tick_time) {\r\n    drawSpot({ spot_time: exit_tick_time, label: 'exit_tick_time', color: 'orange' });\r\n  }\r\n\r\n  if (!is_sold_before_expiry) drawSpot({ spot_time: exit_tick_time, label: 'exit_tick_time', color: 'orange' });\r\n\r\n  function drawSpot({ spot_time, label, color }) {\r\n    if (!spot_time || state.chart.hasLabel(label)) return;\r\n\r\n    const series_spot = chart.series[0].data.find((marker) => +marker.x === (+spot_time * 1000));\r\n    if (!series_spot) return;\r\n\r\n    const marker = ChartSettings.getMarkerSettings(color);\r\n    series_spot.update({ marker });\r\n  }\r\n}\r\n\r\nfunction drawXLines(contract, state, chart) {\r\n  const { entry_tick_time, exit_tick_time, date_start, date_expiry, tick_count, sell_time } = contract;\r\n\r\n  if (tick_count) { // only for tick contracts\r\n    drawXLine({ line_time: entry_tick_time, label: 'start_time' });\r\n    drawXLine({ line_time: exit_tick_time, label: 'end_time', dashStyle: 'Dash' });\r\n    return;\r\n  }\r\n\r\n  drawXLine({ line_time: date_start, label: 'start_time' });\r\n  drawEndTime(contract);\r\n  drawPurchaseTime(contract);\r\n\r\n  function drawXLine({ line_time, label, dashStyle, color }) {\r\n    if (!line_time || state.chart.hasLabel(label)) return false;\r\n\r\n    chart.addPlotLineX({ value: +line_time * 1000, dashStyle, color});\r\n  }\r\n\r\n  function drawEndTime({ is_path_dependent }) {\r\n    const { is_sold_before_expiry } = state.proposal_open_contract;\r\n\r\n    if (is_path_dependent && exit_tick_time && is_sold_before_expiry) {\r\n      drawXLine({ line_time: exit_tick_time, label: 'end_time', dashStyle: 'Dash' });\r\n    }\r\n\r\n    if (is_sold_before_expiry) drawXLine({ line_time: sell_time, label: 'end_time', dashStyle: 'Dash' });\r\n    if (!is_path_dependent) drawXLine({ line_time: date_expiry, label: 'end_time', dashStyle: 'Dash' });\r\n  }\r\n\r\n  function drawPurchaseTime({ purchase_time }) {\r\n    if (date_start > purchase_time) {\r\n      drawXLine({ line_time: purchase_time, label: 'purchase_time', color:'#7cb5ec' });\r\n    }\r\n  }\r\n}\r\n\r\nconst onContractFinished = (state) => {\r\n  state.proposal_open_contract.is_ended = true;\r\n  state.sell.sell_at_market_enabled = false;\r\n};\r\n\r\nconst makeNote = (contract) => {\r\n    if (contract.validation_error) return contract.validation_error;\r\n    if (contract.status !== 'open') return NOTE_TEXT.FINISHED;\r\n    if (contract.is_expired || contract.is_sold) return NOTE_TEXT.EXPIRED;\r\n    if (contract.is_valid_to_sell) return NOTE_TEXT.MARKET_RATE;\r\n    if (!contract.is_valid_to_sell) return NOTE_TEXT.NO_RESALE;\r\n};\r\n\r\nconst drawSparkline = (contract, state) => {\r\n  if (state.sell.bid_prices.length > 40) state.sell.bid_prices.shift();\r\n\r\n  state.sell.bid_prices.push(contract.bid_price);\r\n};\r\n\r\nconst init_dialog = (proposal) => {\r\n   require(['text!viewtransaction/viewTransaction.html'], (html) => {\r\n      const root = $(html).i18n();\r\n      const state = initState(proposal, root);\r\n\r\n      const transWin = windows.createBlankWindow(root, {\r\n         title: proposal.display_name + ' (' + proposal.transaction_id + ')',\r\n         width: 700,\r\n         minWidth: 630,\r\n         minHeight: 480,\r\n         height: 480,\r\n         destroy: () => {},\r\n         close: function() {\r\n            view && view.unbind();\r\n            liveapi.proposal_open_contract.forget(proposal.contract_id);\r\n            liveapi.events.off('proposal_open_contract', on_proposal_open_contract_cb);\r\n            for(let i = 0; i < state.onclose.length; ++i)\r\n               state.onclose[i]();\r\n            $(this).dialog('destroy').remove();\r\n            open_dialogs[proposal.transaction_id] = undefined;\r\n         },\r\n         open: () => {\r\n          liveapi.proposal_open_contract.forget(proposal.contract_id);\r\n         },\r\n         resize: () => {\r\n            state.chart.manualReflow();\r\n         },\r\n         'data-authorized': 'true'\r\n      });\r\n\r\n      transWin.dialog('open');\r\n      const view = rv.bind(root[0], state);\r\n      open_dialogs[proposal.transaction_id] = transWin;\r\n   });\r\n};\r\n\r\nconst sellAtMarket = (state, root) => {\r\n   state.sell.sell_at_market_enabled = false;\r\n   require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css']);\r\n   liveapi.send({ sell: state.proposal_open_contract.contract_id, price: 0 })\r\n      .then((data) => {\r\n         state.proposal_open_contract.is_sold_before_expiry = true;\r\n         const { sell } = data;\r\n         require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css'],\r\n            (html) => {\r\n               const { buy_price, longcode, currency } = state.proposal_open_contract;\r\n               const state_confirm = {\r\n                  longcode,\r\n                  buy_price,\r\n                  sell_price: sell.sold_for,\r\n                  return_percent: (100 * (sell.sold_for - buy_price) / buy_price).toFixed(2) + '%',\r\n                  transaction_id: sell.transaction_id,\r\n                  balance: sell.balance_after,\r\n                  currency,\r\n               };\r\n               const $html = $(html).i18n();\r\n               root.after($html);\r\n               const view_confirm = rv.bind($html[0], state_confirm);\r\n               state.onclose.push(() => {\r\n                  view_confirm && view_confirm.unbind();\r\n               });\r\n            });\r\n      })\r\n      .catch((err) => {\r\n         $.growl.error({ message: err.message });\r\n         console.error(err);\r\n      });\r\n};\r\n\r\nconst initState = (proposal, root) => {\r\n   const sell_time = proposal.is_path_dependent && proposal.status !== 'sold' ? proposal.exit_tick_time : parseInt(proposal.sell_time);\r\n\r\n   const state = {\r\n      route: {\r\n         value: 'table',\r\n         update: (value) => { state.route.value = value; },\r\n      },\r\n      note: makeNote(proposal),\r\n      chart: {\r\n         chart: null, /* highchart object */\r\n         loading: 'Loading ' + proposal.display_name + ' ...',\r\n         added_labels: [],\r\n         hasLabel: (label) => {\r\n          if (state.chart.added_labels.includes(label)) return true;\r\n\r\n          state.chart.added_labels.push(label);\r\n          return false;\r\n         },\r\n         type: 'ticks', // could be 'tick' or 'ohlc'\r\n         manualReflow: () => {\r\n          if (!state.chart.chart) return;\r\n\r\n          const h = -1 * (root.find('.longcode').height() + root.find('.tabs').height() + root.find('.footer').height()) - 16;\r\n          const container = root;\r\n          const width = container.width() - 10;\r\n          const height = container.height();\r\n\r\n          state.chart.chart.setSize(width, height + h , false);\r\n          state.chart.chart.hasUserSize = null;\r\n          if (state.chart.chart.series[0] && state.chart.chart.series[0].data.length === 0) {\r\n            state.chart.chart.showLoading();\r\n            return;\r\n          }\r\n          state.chart.chart.hideLoading();\r\n       },\r\n      },\r\n      proposal_open_contract: {\r\n        ...proposal,\r\n        currency: (proposal.currency ||  'USD') + ' ',\r\n        is_ended: proposal.is_settleable || proposal.is_sold || proposal.status !== 'open',\r\n        is_sold_at_market: false,\r\n        is_sold_before_expiry: sell_time < proposal.date_expiry,\r\n        isLookback: Lookback.isLookback(proposal.contract_type),\r\n        lb_formula: Lookback.formula(proposal.contract_type, proposal.multiplier && formatPrice(proposal.multiplier, proposal.currency ||  'USD')),\r\n        pip: 0,\r\n      },\r\n      sell: {\r\n         bid_prices: [],\r\n         bid_price: {\r\n            unit: undefined,\r\n            cent: undefined,\r\n            value: undefined,\r\n         },\r\n         sell: () => sellAtMarket(state, root),\r\n         sell_at_market_enabled: true,\r\n      },\r\n      onclose: [], /* cleanup callback array when dialog is closed */\r\n   };\r\n   setupChart(state, root);\r\n   return state;\r\n};\r\n\r\nlet on_proposal_open_contract_cb;\r\nfunction getContractData(state, proposal) {\r\n  on_proposal_open_contract_cb = onProposalOpenContract;\r\n\r\n  liveapi.proposal_open_contract.subscribe(proposal.contract_id)\r\n  liveapi.events.on('proposal_open_contract', on_proposal_open_contract_cb);\r\n\r\n  function onProposalOpenContract(data) {\r\n    const is_different_stream = +data.proposal_open_contract.contract_id !== +state.proposal_open_contract.contract_id;\r\n    if (is_different_stream) return;\r\n\r\n    if (data.error) {\r\n      handleError(data.error.message);\r\n      return;\r\n    }\r\n    updateIndicative(data, state);\r\n  }\r\n}\r\n\r\nconst updateLiveChart = (state, granularity) => {\r\n  const key = chartingRequestMap.keyFor(state.proposal_open_contract.underlying, granularity);\r\n  handleChartingRequestMap(key);\r\n\r\n  let on_tick_cb = undefined;\r\n  let on_candles_cb = undefined;\r\n  let clean_up_done = false;\r\n  state.onclose.push(cleanUp);\r\n\r\n  if (granularity === 0) {\r\n    handleTick();\r\n    return;\r\n  }\r\n  handleCandle();\r\n\r\n  /* don't register if already someone else has registered for this symbol */\r\n  function handleChartingRequestMap() {\r\n    if(!chartingRequestMap[key]){\r\n      const req = makeChartingRequestMapRequest(granularity, state.proposal_open_contract.underlying);\r\n      chartingRequestMap.register(req)\r\n          .catch((err) => {\r\n            $.growl.error({ message: err.message });\r\n            console.error(err);\r\n          });\r\n    } else {\r\n      chartingRequestMap.subscribe(key);\r\n    }\r\n  }\r\n\r\n  function makeChartingRequestMapRequest(granularity, symbol) {\r\n    return ({\r\n      symbol,\r\n      subscribe: 1,\r\n      granularity,\r\n      style: granularity === 0 ? 'ticks' : 'candles',\r\n    });\r\n  }\r\n\r\n  function handleTick() {\r\n    on_tick_cb = liveapi.events.on('tick', (data) => {\r\n        if (!data.tick || data.tick.symbol !== state.proposal_open_contract.underlying) return;\r\n\r\n        const { chart } = state.chart;\r\n        const { status, is_sold, exit_tick, exit_tick_time } = state.proposal_open_contract;\r\n        const { tick } = data;\r\n\r\n        const contract_has_finished = is_sold || status !== 'open' || exit_tick || exit_tick_time;\r\n        if (contract_has_finished) {\r\n          cleanUp();\r\n          return;\r\n        };\r\n\r\n        addTickToChart(chart, tick);\r\n    });\r\n\r\n    function addTickToChart(chart, tick) {\r\n      if (!chart) return;\r\n      chart.series[0].addPoint([tick.epoch * 1000, tick.quote * 1, 'gray']);\r\n    }\r\n  }\r\n\r\n  function handleCandle() {\r\n    on_candles_cb = liveapi.events.on('ohlc', (data) => {\r\n      const data_key = chartingRequestMap.keyFor(data.ohlc.symbol, data.ohlc.granularity);\r\n      if (key !== data_key) return;\r\n\r\n      const { chart } = state.chart;\r\n      if (!chart) return;\r\n\r\n      const series = chart.series[0];\r\n      const last = series.data[series.data.length - 1];\r\n\r\n      const c = data.ohlc;\r\n      const ohlc = [c.open_time * 1000, c.open * 1, c.high * 1, c.low * 1, c.close * 1];\r\n\r\n      if (last.x !== ohlc[0]) {\r\n          series.addPoint(ohlc, true, true);\r\n      } else {\r\n        last.update(ohlc,true);\r\n      }\r\n      const { status, is_sold, exit_tick, exit_tick_time, date_expiry} = state.proposal_open_contract;\r\n      const contract_has_finished = (c.epoch * 1 > date_expiry * 1) || status !== 'open' || exit_tick || exit_tick_time;\r\n\r\n      if (contract_has_finished) cleanUp();\r\n    });\r\n  }\r\n\r\n  function cleanUp() {\r\n    if (clean_up_done) return;\r\n    clean_up_done = true;\r\n\r\n    chartingRequestMap.unregister(key);\r\n    on_tick_cb && liveapi.events.off('tick', on_tick_cb);\r\n    on_candles_cb && liveapi.events.off('candles', on_candles_cb);\r\n  }\r\n};\r\n\r\nconst drawBarriers = (contract, state) => {\r\n  const { chart } = state.chart;\r\n  const { barrier, high_barrier, low_barrier, tick_count } = state.proposal_open_contract;\r\n\r\n  removeBarriers(barrier, high_barrier, low_barrier);\r\n  addBarrierToChart(barrier, high_barrier, low_barrier);\r\n\r\n  function addBarrierToChart(barrier, high_barrier, low_barrier) {\r\n    const dashStyle = tick_count ? '' : 'dot';\r\n\r\n    if (barrier)  chart.addPlotLineY({ id: 'barrier', value: barrier, dashStyle })\r\n    if (high_barrier) chart.addPlotLineY({ id: 'high_barrier', value: high_barrier, dashStyle })\r\n    if (low_barrier) chart.addPlotLineY({ id: 'low_barrier', value: low_barrier, dashStyle })\r\n  }\r\n\r\n  function removeBarriers(barrier, high_barrier, low_barrier) {\r\n    if (barrier) chart.yAxis[0].removePlotLine('barrier');\r\n    if (high_barrier) chart.yAxis[0].removePlotLine('high_barrier');\r\n    if (low_barrier) chart.yAxis[0].removePlotLine('low_barrier');\r\n  }\r\n}\r\n\r\nconst setupChart = (state, root) => {\r\n  const duration = Math.min(+state.proposal_open_contract.date_expiry, moment.utc().unix()) - (state.proposal_open_contract.purchase_time || state.proposal_open_contract.date_start);\r\n  const granularity = makeGranularity(duration);\r\n  const margin = makeTimeMargin(duration, granularity);\r\n  const tick_history_request = makeTickHistoryRequest(granularity, margin);\r\n\r\n  // setup tick/candle stream for chart\r\n  if (!state.proposal_open_contract.is_ended) updateLiveChart(state, granularity);\r\n\r\n  liveapi.send(tick_history_request)\r\n    .then((data) => {\r\n      onTickHistorySuccess(data);\r\n      getContractData(state, state.proposal_open_contract);\r\n    }).catch((err) => {\r\n      onTickHistoryError(err);\r\n  });\r\n\r\n  function makeGranularity(duration) {\r\n    let granularity = 0;\r\n\r\n    if (duration <= 60 * 60) { granularity = 0; } // 1 hour\r\n    else if (duration <= 2 * 60 * 60) { granularity = 60; } // 2 hours\r\n    else if (duration <= 6 * 60 * 60) { granularity = 120; } // 6 hours\r\n    else if (duration <= 24 * 60 * 60) { granularity = 300; } // 1 day\r\n    else { granularity = 3600 } // more than 1 day\r\n    return granularity;\r\n  }\r\n\r\n  function makeTimeMargin(duration, granularity) {\r\n    let margin = 0;\r\n    margin = (granularity === 0) ? Math.max(3, 30 * duration / (60 * 60) | 0) : 3 * granularity;\r\n    return margin;\r\n  }\r\n\r\n  function makeTickHistoryRequest(granularity, margin) {\r\n    const { date_start, current_spot_time, purchase_time, exit_tick_time } = state.proposal_open_contract;\r\n    const is_forward_starting = +date_start > +purchase_time;\r\n    let start;\r\n\r\n    if (is_forward_starting) {\r\n      start = purchase_time;\r\n    } else {\r\n      const contract_has_not_started = (+date_start > +current_spot_time) || +exit_tick_time < +date_start;\r\n      start = contract_has_not_started ? +purchase_time : (+date_start || +purchase_time);\r\n    }\r\n    const end = ((start > exit_tick_time) || !exit_tick_time) ? 'latest' : +exit_tick_time + margin;\r\n\r\n    const request = {\r\n      adjust_start_time: 1,\r\n      ticks_history: state.proposal_open_contract.underlying,\r\n      start: start - margin, /* load around 2 more ticks before start */\r\n      end,\r\n      style: 'ticks',\r\n      count: 4999, /* maximum number of ticks possible */\r\n    };\r\n\r\n    if (granularity !== 0) {\r\n      request.granularity = granularity;\r\n      request.style = 'candles';\r\n      state.chart.type = 'candles';\r\n    }\r\n    return request;\r\n  }\r\n\r\n\r\n  function onTickHistorySuccess(data) {\r\n    state.chart.loading = '';\r\n    const chart_options = makeChartOptions(data, state.proposal_open_contract.display_name);\r\n    const chart = initChart(root, state, chart_options);\r\n    state.chart.chart = chart;\r\n    state.chart.manualReflow();\r\n\r\n    function makeChartOptions(data, title) {\r\n      return ({ title, ...data });\r\n    }\r\n  }\r\n\r\n  function onTickHistoryError(err) {\r\n    state.chart.loading = err.message;\r\n    console.error(err);\r\n  }\r\n};\r\n\r\nexport default  { init };\r\n"]}