{"version":3,"sources":["../../../../src/instruments/instruments.es6"],"names":["get_active_symbol","landing_company","country","liveapi","send","active_symbols","then","data","filtered_symbols","local_storage","set","active_markets","_","groupBy","map","symbols","sym","head","market","name","display_name","market_display_name","submarkets","submarket","submarket_display_name","instruments","push","symbol","value","markets","chartable_markets","m","sm","filter","ins","indexOf","length","find","remove","menu","refreshMenu","onMenuItemClick","catch","err","$","growl","error","message","refresh_active_symbols","get","cached","authorize","displayName","chartWindow","addNewWindow","instrumentCode","instrumentName","timePeriod","type","init","trading_times","Date","toISOString","slice","extractChartableMarkets","events","on","getMarketData","isMarketDataPresent","marketDataDisplayName","marketData","present","instrumentObj","each","key","trim","getSpecificMarketData","isEmptyObject"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAQA,QAAMA,oBAAoB,SAApBA,iBAAoB,CAACC,eAAD,EAAkBC,OAAlB,EAA8B;;AAEpDC,oCACKC,IADL,CACU,EAAEC,gBAAgB,OAAlB,EADV,EAEKC,IAFL,CAEU,UAASC,IAAT,EAAe;AACjB,gBAAMF,iBAAiB,EAAvB;AACA,gBAAIG,yBAAJ;;AAEAC,0BAAcC,GAAd,CAAkB,gBAAlB,EAAoCH,KAAKF,cAAzC;;AAEA,gBAAMM,iBAAiBC,EAAEL,KAAKF,cAAP,EAAuBQ,OAAvB,CAA+B,QAA/B,EAAyCC,GAAzC,CAA6C,UAAUC,OAAV,EAAmB;AACnF,oBAAMP,mBAAmBO,OAAzB;AACA,oBAAMC,MAAMJ,EAAEK,IAAF,CAAOT,gBAAP,CAAZ;AACA,oBAAMU,SAAS,EAAEC,MAAMH,IAAIE,MAAZ,EAAoBE,cAAcJ,IAAIK,mBAAtC,EAAf;AACAH,uBAAOI,UAAP,GAAoBV,EAAEJ,gBAAF,EAAoBK,OAApB,CAA4B,WAA5B,EAAyCC,GAAzC,CAA6C,UAAUC,OAAV,EAAmB;AAChF,wBAAMC,MAAMJ,EAAEK,IAAF,CAAOF,OAAP,CAAZ;AACA,wBAAMQ,YAAY,EAAEJ,MAAMH,IAAIO,SAAZ,EAAuBH,cAAcJ,IAAIQ,sBAAzC,EAAlB;AACAD,8BAAUE,WAAV,GAAwBb,EAAEE,GAAF,CAAMC,OAAN,EAAe,UAAUC,GAAV,EAAe;AAClDX,uCAAeqB,IAAf,CAAoBV,IAAIW,MAAxB;AACA,+BAAO;AACHA,oCAAQX,IAAIW,MADT;AAEHP,0CAAcJ,IAAII;AAFf,yBAAP;AAIH,qBANuB,CAAxB;AAOA,2BAAOG,SAAP;AACH,iBAXmB,EAWjBK,KAXiB,EAApB;AAYA,uBAAOV,MAAP;AACH,aAjBsB,EAiBpBU,KAjBoB,EAAvB;AAkBAC,sBAAUC,kBAAkBhB,GAAlB,CAAsB,UAAUiB,CAAV,EAAa;AACzC,uBAAO;AACHX,kCAAcW,EAAEX,YADb;AAEHD,0BAAMY,EAAEZ,IAFL;AAGHG,gCAAYS,EAAET,UAAF,CAAaR,GAAb,CAAiB,UAAUkB,EAAV,EAAc;AACvC,+BAAO;AACHZ,0CAAcY,GAAGZ,YADd;AAEHK,yCAAaO,GAAGP,WAAH,CAAeQ,MAAf,CAAsB,UAAUC,GAAV,EAAe;AAC9C,uCAAO7B,eAAe8B,OAAf,CAAuBD,IAAIP,MAA3B,MAAuC,CAAC,CAA/C;AACH,6BAFY;AAFV,yBAAP;AAMH,qBAPW,EAOTM,MAPS,CAOF,UAAUD,EAAV,EAAc;AACpB,+BAAOA,GAAGP,WAAH,CAAeW,MAAf,KAA0B,CAAjC;AACH,qBATW;AAHT,iBAAP;AAcH,aAfS,EAePH,MAfO,CAeA,UAAUF,CAAV,EAAa;AACnB,uBAAOA,EAAET,UAAF,CAAac,MAAb,KAAwB,CAA/B;AACH,aAjBS,CAAV;AAkBAP,sBAAU,4CAA0BlB,cAA1B,CAAV;AACA,gBAAMc,cAAc,sBAAE,WAAF,EAAeY,IAAf,CAAoB,cAApB,CAApB;AACAZ,wBAAYY,IAAZ,CAAiB,MAAjB,EAAyBC,MAAzB;AACAC,2BAAKC,WAAL,CAAiBf,WAAjB,EAA8BI,OAA9B,EAAuCY,eAAvC;AACH,SAhDL,EAiDKC,KAjDL,CAiDW,UAACC,GAAD,EAAS;AACZC,6BAAEC,KAAF,CAAQC,KAAR,CAAc,EAAEC,SAASJ,IAAII,OAAf,EAAd;AACH,SAnDL;AAoDH,KAtDD;;AAwDA,aAASC,sBAAT,GAAkC;AAC9B,YAAIvC,cAAcwC,GAAd,CAAkB,OAAlB,CAAJ,EAAgC;AAC5B9C,wCACC+C,MADD,CAECC,SAFD,GAGC7C,IAHD,CAGM,YAAM;AACR,oBAAMJ,UAAUO,cAAcwC,GAAd,CAAkB,WAAlB,EAA+B/C,OAA/C;AACAC,4CACC+C,MADD,CAEC9C,IAFD,CAEM,EAAEH,iBAAiBC,OAAnB,EAFN,EAGCI,IAHD,CAGM,UAACC,IAAD,EAAU;AACb,wBAAMN,kBAAkBM,KAAKN,eAA7B;AACAD,sCAAkBC,eAAlB,EAAmCC,OAAnC;AACF,iBAND;AAOH,aAZD,EAaCwC,KAbD,CAaO,UAACC,GAAD,EAAS;AACZC,iCAAEC,KAAF,CAAQC,KAAR,CAAc,EAAEC,SAASJ,IAAII,OAAf,EAAd;AACF,aAfF;AAgBH,SAjBD,MAiBO;AACH/C;AACH;AACJ;;AAED,aAASyC,eAAT,CAAyBd,MAAzB,EAAiCyB,WAAjC,EAA8C;AAC1CC,8BAAYC,YAAZ,CAAyB;AACrBC,4BAAgB5B,MADK;AAErB6B,4BAAgBJ,WAFK;AAGrBK,wBAAY,IAHS;AAIrBC,kBAAM;AAJe,SAAzB;AAMH;;AAED,QAAI7B,UAAU,EAAd;AACA,QAAIC,oBAAoB,EAAxB;;AAEO,QAAM6B,sBAAO,SAAPA,IAAO,GAAY;AAC5B,eAAOxD,4BACF+C,MADE,CACK9C,IADL,CACU,EAAEwD,eAAe,IAAIC,IAAJ,GAAWC,WAAX,GAAyBC,KAAzB,CAA+B,CAA/B,EAAkC,EAAlC,CAAjB,EADV,EAEFzD,IAFE,CAEG,UAAUC,IAAV,EAAgB;AAClBuB,gCAAoBS,eAAKyB,uBAAL,CAA6BzD,IAA7B,CAApB;AACAyC;AACA7C,wCAAQ8D,MAAR,CAAeC,EAAf,CAAkB,OAAlB,EAA2BlB,sBAA3B;AACA7C,wCAAQ8D,MAAR,CAAeC,EAAf,CAAkB,QAAlB,EAA4BlB,sBAA5B;;AAEA,mBAAOlB,iBAAP;AACH,SATE,CAAP;AAUH,KAXM;;AAaA,QAAMqC,wCAAgB,SAAhBA,aAAgB,GAAY;AACrC,eAAOtC,OAAP;AACH,KAFM;;AAIA,QAAMuC,oDAAsB,SAAtBA,mBAAsB,CAAUC,qBAAV,EAAiCC,UAAjC,EAA6C;AAC5E,YAAIC,UAAU,KAAd;AACA,YAAI,CAACD,UAAL,EAAiB;AACbA,yBAAazC,OAAb;AACH;;AAED,YAAM2C,gBAAgB,IAAtB;AACA5B,yBAAE6B,IAAF,CAAOH,UAAP,EAAmB,UAAUI,GAAV,EAAe9C,KAAf,EAAsB;AACrC,gBAAIA,MAAMN,UAAN,IAAoBM,MAAMH,WAA9B,EAA2C;AACvC8C,0BAAUC,cAAcJ,mBAAd,CAAkCC,qBAAlC,EAAyDzC,MAAMN,UAAN,IAAoBM,MAAMH,WAAnF,CAAV;AACH,aAFD,MAEO;AACH,oBAAImB,iBAAE+B,IAAF,CAAO/C,MAAMR,YAAb,KAA8BwB,iBAAE+B,IAAF,CAAON,qBAAP,CAAlC,EAAiE;AAC7DE,8BAAU,IAAV;AACH;AACJ;AACD,mBAAO,CAACA,OAAR;AACH,SATD;AAUA,eAAOA,OAAP;AACH,KAlBM;;AAoBA,QAAMK,wDAAwB,SAAxBA,qBAAwB,CAAUP,qBAAV,EAAiCC,UAAjC,EAA6C;AAC9E,YAAIC,UAAU,EAAd;AACA,YAAI,CAACD,UAAL,EAAiB;AACbA,yBAAazC,OAAb;AACH;;AAED,YAAM2C,gBAAgB,IAAtB;AACA5B,yBAAE6B,IAAF,CAAOH,UAAP,EAAmB,UAAUI,GAAV,EAAe9C,KAAf,EAAsB;AACrC,gBAAIA,MAAMN,UAAN,IAAoBM,MAAMH,WAA9B,EAA2C;AACvC8C,0BAAUC,cAAcI,qBAAd,CAAoCP,qBAApC,EAA2DzC,MAAMN,UAAN,IAAoBM,MAAMH,WAArF,CAAV;AACH,aAFD,MAEO;AACH,oBAAImB,iBAAE+B,IAAF,CAAO/C,MAAMR,YAAb,KAA8BwB,iBAAE+B,IAAF,CAAON,qBAAP,CAAlC,EAAiE;AAC7DE,8BAAU3C,KAAV;AACH;AACJ;AACD,mBAAOgB,iBAAEiC,aAAF,CAAgBN,OAAhB,CAAP;AACH,SATD;AAUA,eAAOA,OAAP;AACH,KAlBM;;sBAoBQ;AACXZ,kBADW;AAEXQ,oCAFW;AAGXC,gDAHW;AAIXQ;AAJW,K","file":"instruments.js","sourcesContent":["import $ from \"jquery\";\r\nimport liveapi from \"websockets/binary_websockets\";\r\nimport menu from \"navigation/menu\";\r\nimport chartWindow from \"charts/chartWindow\";\r\nimport { getSortedMarketSubmarkets } from '../common/marketUtils';\r\nimport \"jquery-growl\";\r\nimport \"common/util\";\r\n\r\nconst get_active_symbol = (landing_company, country) => {\r\n\r\n    liveapi\r\n        .send({ active_symbols: 'brief' })\r\n        .then(function(data) {\r\n            const active_symbols = [];\r\n            let filtered_symbols;\r\n    \r\n            local_storage.set('active_symbols', data.active_symbols);\r\n\r\n            const active_markets = _(data.active_symbols).groupBy('market').map(function (symbols) {\r\n                const filtered_symbols = symbols;\r\n                const sym = _.head(filtered_symbols);\r\n                const market = { name: sym.market, display_name: sym.market_display_name };\r\n                market.submarkets = _(filtered_symbols).groupBy('submarket').map(function (symbols) {\r\n                    const sym = _.head(symbols);\r\n                    const submarket = { name: sym.submarket, display_name: sym.submarket_display_name };\r\n                    submarket.instruments = _.map(symbols, function (sym) {\r\n                        active_symbols.push(sym.symbol);\r\n                        return {\r\n                            symbol: sym.symbol,\r\n                            display_name: sym.display_name,\r\n                        };\r\n                    });\r\n                    return submarket;\r\n                }).value();\r\n                return market;\r\n            }).value();\r\n            markets = chartable_markets.map(function (m) {\r\n                return {\r\n                    display_name: m.display_name,\r\n                    name: m.name,\r\n                    submarkets: m.submarkets.map(function (sm) {\r\n                        return {\r\n                            display_name: sm.display_name,\r\n                            instruments: sm.instruments.filter(function (ins) {\r\n                                return active_symbols.indexOf(ins.symbol) !== -1;\r\n                            })\r\n                        }\r\n                    }).filter(function (sm) {\r\n                        return sm.instruments.length !== 0;\r\n                    })\r\n                }\r\n            }).filter(function (m) {\r\n                return m.submarkets.length !== 0;\r\n            });\r\n            markets = getSortedMarketSubmarkets(active_markets);\r\n            const instruments = $(\"#nav-menu\").find(\".instruments\");\r\n            instruments.find('> ul').remove();\r\n            menu.refreshMenu(instruments, markets, onMenuItemClick);\r\n        })\r\n        .catch((err) => {\r\n            $.growl.error({ message: err.message });\r\n        });\r\n}\r\n\r\nfunction refresh_active_symbols() {\r\n    if (local_storage.get('oauth')) {\r\n        liveapi\r\n        .cached\r\n        .authorize()\r\n        .then(() => {\r\n            const country = local_storage.get('authorize').country;\r\n            liveapi\r\n            .cached\r\n            .send({ landing_company: country })\r\n            .then((data) => {\r\n               const landing_company = data.landing_company\r\n               get_active_symbol(landing_company, country);\r\n            });\r\n        })\r\n        .catch((err) => {\r\n            $.growl.error({ message: err.message });\r\n         });\r\n    } else {\r\n        get_active_symbol();\r\n    }\r\n}\r\n\r\nfunction onMenuItemClick(symbol, displayName) {\r\n    chartWindow.addNewWindow({\r\n        instrumentCode: symbol,\r\n        instrumentName: displayName,\r\n        timePeriod: '1d',\r\n        type: 'candlestick'\r\n    });\r\n}\r\n\r\nlet markets = [];\r\nlet chartable_markets = [];\r\n\r\nexport const init = function () {\r\n    return liveapi\r\n        .cached.send({ trading_times: new Date().toISOString().slice(0, 10) })\r\n        .then(function (data) {\r\n            chartable_markets = menu.extractChartableMarkets(data);\r\n            refresh_active_symbols();\r\n            liveapi.events.on('login', refresh_active_symbols);\r\n            liveapi.events.on('logout', refresh_active_symbols);\r\n\r\n            return chartable_markets;\r\n        });\r\n}\r\n\r\nexport const getMarketData = function () {\r\n    return markets;\r\n}\r\n\r\nexport const isMarketDataPresent = function (marketDataDisplayName, marketData) {\r\n    let present = false;\r\n    if (!marketData) {\r\n        marketData = markets;\r\n    }\r\n\r\n    const instrumentObj = this;\r\n    $.each(marketData, function (key, value) {\r\n        if (value.submarkets || value.instruments) {\r\n            present = instrumentObj.isMarketDataPresent(marketDataDisplayName, value.submarkets || value.instruments);\r\n        } else {\r\n            if ($.trim(value.display_name) == $.trim(marketDataDisplayName)) {\r\n                present = true;\r\n            }\r\n        }\r\n        return !present;\r\n    });\r\n    return present;\r\n}\r\n\r\nexport const getSpecificMarketData = function (marketDataDisplayName, marketData) {\r\n    let present = {};\r\n    if (!marketData) {\r\n        marketData = markets;\r\n    }\r\n\r\n    const instrumentObj = this;\r\n    $.each(marketData, function (key, value) {\r\n        if (value.submarkets || value.instruments) {\r\n            present = instrumentObj.getSpecificMarketData(marketDataDisplayName, value.submarkets || value.instruments);\r\n        } else {\r\n            if ($.trim(value.display_name) == $.trim(marketDataDisplayName)) {\r\n                present = value;\r\n            }\r\n        }\r\n        return $.isEmptyObject(present);\r\n    });\r\n    return present;\r\n}\r\n\r\nexport default {\r\n    init,\r\n    getMarketData,\r\n    isMarketDataPresent,\r\n    getSpecificMarketData\r\n}\r\n"]}