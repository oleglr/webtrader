{"version":3,"sources":["../../../../src/statement/statement.es6"],"names":["statement","table","datepicker","init","$menuLink","click","liveapi","cached","authorize","then","initStatement","catch","err","console","error","moveToTop","loading","is_specific_date_shown","scroll_end_reached","refreshTable","yyy_mm_dd","processing_msg","attr","css","show","request","description","date_from","yearMonthDayToEpoch","utc","one_day_utc","Date","UTC","date_to","api","rows","remove","limit","clear","offset","column","data","length","refresh","transactions","view_button_text","i18n","map","trans","class_name","includes","action_type","view_button","amount","epochToString","transaction_time","transaction_id","_","capitalize","longcode","formatPrice","balance_after","local_storage","get","add","draw","count","hide","send","$","growl","message","windows","createBlankWindow","title","dialogClass","width","height","close","DataTable","destroy","track","module_id","is_unique","html","appendTo","dataTable","autoWidth","td","cellData","css_class","addClass","innerHTML","paging","ordering","searching","processing","closest","columns","every","header","on","search","value","addDateToHeader","date","changed","cleared","on_arrow_click","dialog","scroll","scrollTop","innerHeight","scrollHeight","postion","e","target","$target","tagName","hasClass","tr","parentElement","transaction","row","last","viewTransaction","contract_id","removeClass"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAaA,OAAIA,YAAY,IAAhB;AAAA,OACGC,QAAQ,IADX;AAAA,OAEGC,aAAa,IAFhB,C,CAbC;;;AAiBM,OAAMC,sBAAO,SAAPA,IAAO,CAACC,SAAD,EAAe;AAChCA,gBAAUC,KAAV,CAAgB,YAAM;AACnB,aAAI,CAACL,SAAL,EACGM,4BAAQC,MAAR,CAAeC,SAAf,GACIC,IADJ,CACSC,aADT,EAEIC,KAFJ,CAGM,UAACC,GAAD;AAAA,mBAASC,QAAQC,KAAR,CAAcF,GAAd,CAAT;AAAA,UAHN,EADH,KAOGZ,UAAUe,SAAV;AACL,OATD;AAUF,IAXM;;AAaP,OAAIC,UAAU,KAAd;AACA,OAAIC,yBAAyB,KAA7B,C,CAAoC;AACpC,OAAIC,qBAAqB,KAAzB;;AAEA,OAAMC,eAAgB,SAAhBA,YAAgB,CAACC,SAAD,EAAe;AAClC,UAAMC,iBAAiB,sBAAE,MAAMpB,MAAMqB,IAAN,CAAW,IAAX,CAAN,GAAyB,aAA3B,EAA0CC,GAA1C,CAA8C,KAA9C,EAAoD,OAApD,EAA6DC,IAA7D,EAAvB;;AAEA,UAAMC,UAAU;AACbzB,oBAAW,CADE;AAEb0B,sBAAa;AAFA,OAAhB;;AAKA;AACA,UAAI,OAAON,SAAP,KAAqB,QAAzB,EAAmC;AAChCK,iBAAQE,SAAR,GAAoBC,oBAAoBR,SAApB,EAA+B,EAAES,KAAK,IAAP,EAA/B,CAApB;AACA,aAAMC,cAAcC,KAAKC,GAAL,CAAS,IAAT,EAAe,CAAf,EAAkB,CAAlB,EAAqB,EAArB,EAAyB,EAAzB,EAA6B,EAA7B,IAAmC,IAAvD;AACAP,iBAAQQ,OAAR,GAAkBR,QAAQE,SAAR,GAAoBG,WAAtC;AACA7B,eAAMiC,GAAN,GAAYC,IAAZ,GAAmBC,MAAnB;AACAnB,kCAAyB,IAAzB;AACF,OAND,MAOM;AAAE;AACLQ,iBAAQY,KAAR,GAAgB,GAAhB;AACA,aAAIpB,0BAA2BG,aAAaA,UAAUkB,KAAtD,EAA8D;AAC3DrC,kBAAMiC,GAAN,GAAYC,IAAZ,GAAmBC,MAAnB;AACAnB,qCAAyB,KAAzB;AACF;AACDQ,iBAAQc,MAAR,GAAiBtC,MAAMiC,GAAN,GAAYM,MAAZ,CAAmB,CAAnB,EAAsBC,IAAtB,GAA6BC,MAA9C;AACF;;AAED;AACA,UAAMC,UAAU,SAAVA,OAAU,CAACF,IAAD,EAAU;AACvB,aAAMG,eAAgBH,KAAKzC,SAAL,IAAkByC,KAAKzC,SAAL,CAAe4C,YAAlC,IAAmD,EAAxE;AACA,aAAMC,mBAAmB,OAAOC,IAAP,EAAzB;AACA,aAAMX,OAAOS,aAAaG,GAAb,CAAiB,UAACC,KAAD,EAAW;AACtC,gBAAIC,aAAa,sBAAE,CAAC,KAAD,EAAQ,MAAR,CAAF,EAAmBC,QAAnB,CAA4BF,MAAMG,WAAlC,IAAiD,EAAjD,GAAsD,iBAAvE;AACIF,yBAAa,sBAAE,CAAC,SAAD,EAAY,YAAZ,CAAF,EAA6BC,QAA7B,CAAsCF,MAAMG,WAA5C,IAA2D,WAA3D,GAAyEF,UAAtF;AACJ,gBAAMG,mCAAiCH,UAAjC,WAAkDJ,gBAAlD,cAAN;AACA,gBAAMQ,SAASL,MAAMK,MAAN,GAAe,CAA9B;AACA,mBAAO,CACJC,cAAcN,MAAMO,gBAApB,EAAsC,EAAE1B,KAAK,IAAP,EAAtC,CADI,EAEJmB,MAAMQ,cAFF,EAGJC,iBAAEC,UAAF,CAAaV,MAAMG,WAAnB,CAHI,EAIJH,MAAMW,QAJF,EAKJX,MAAMK,MAAN,GAAe,CALX,EAMJ,QAAQO,YAAYZ,MAAMa,aAAlB,EAAgCC,cAAcC,GAAd,CAAkB,UAAlB,CAAhC,CAAR,GAAyE,MANrE,EAOJX,WAPI,EAQJJ,KARI,CAAP;AAUF,UAfY,CAaA;AAbA,UAAb;AAgBA/C,eAAMiC,GAAN,GAAYC,IAAZ,CAAiB6B,GAAjB,CAAqB7B,IAArB;AACAlC,eAAMiC,GAAN,GAAY+B,IAAZ;AACAjD,mBAAU,KAAV;AACA,aAAIyB,KAAKzC,SAAL,CAAekE,KAAf,KAAyB,CAA7B,EAAgChD,qBAAqB,IAArB;AAChCG,wBAAe8C,IAAf;AACF,OAxBD;;AA0BA,UAAG,CAACnD,OAAJ,EAAa;AACPA,mBAAU,IAAV;AACAV,qCACI8D,IADJ,CACS3C,OADT,EAEIhB,IAFJ,CAESkC,OAFT,EAGIhC,KAHJ,CAGU,UAACC,GAAD,EAAS;AACV+B,oBAAQ,EAAR;AACA0B,6BAAEC,KAAF,CAAQxD,KAAR,CAAc,EAAEyD,SAAS3D,IAAI2D,OAAf,EAAd;AACA1D,oBAAQC,KAAR,CAAcF,GAAd;AACAI,sBAAU,KAAV;AACL,UARJ;AASL;AACH,IAhED;;AAkEA,OAAMN,gBAAgB,SAAhBA,aAAgB,GAAM;AACzBQ,2BAAqB,KAArB;AACAlB,kBAAYwE,kBAAQC,iBAAR,CAA0B,sBAAE,QAAF,CAA1B,EAAuC;AAChDC,gBAAO,YAAY5B,IAAZ,EADyC;AAEhD6B,sBAAa,WAFmC;AAGhDC,gBAAO,GAHyC;AAIhDC,iBAAQ,GAJwC;AAKhDC,gBAAO,iBAAM;AACV7E,qBAASA,MAAM8E,SAAN,GAAkBC,OAAlB,CAA0B,IAA1B,CAAT;AACAhF,yBAAaA,UAAUoC,MAAV,EAAb;AACApC,wBAAY,IAAZ;AACF,UAT+C;AAUhD2C,kBAAS,mBAAM;AACZzC,uBAAWoC,KAAX;AACAnB,yBAAa,EAACmB,OAAM,IAAP,EAAb;AACF,UAb+C;AAchD,4BAAmB;AAd6B,OAAvC,CAAZ;AAgBAtC,gBAAUiF,KAAV,CAAgB;AACbC,oBAAW,WADE;AAEbC,oBAAW,IAFE;AAGb1C,eAAM;AAHO,OAAhB;;AAMAxC,cAAQ,sBAAEmF,mBAAF,EAAQtC,IAAR,EAAR;AACA7C,YAAMoF,QAAN,CAAerF,SAAf;;AAEAC,cAAQA,MAAMqF,SAAN,CAAgB;AACrB7C,eAAM,EADe;AAErB8C,oBAAW,KAFU;AAGrB,uBAAc,CAAE;AACb,uBAAW,CADE;AAEb,qBAAS;AAFI,UAAF,EAGX;AACA,uBAAW,CADX;AAEA,2BAAe,qBAACC,EAAD,EAAKC,QAAL,EAAkB;AAC9B,mBAAMC,YAAaD,WAAW,CAAZ,GAAiB,KAAjB,GAA0BA,WAAW,CAAZ,GAAiB,OAAjB,GAA2B,MAAtE;AACA,mBAAIC,SAAJ,EACG,sBAAEF,EAAF,EAAMG,QAAN,CAAeD,SAAf;AACHF,kBAAGI,SAAH,GAAehC,YAAY6B,QAAZ,EAAsB3B,cAAcC,GAAd,CAAkB,UAAlB,CAAtB,CAAf;AACF;AAPD,UAHW,CAHO;AAerB8B,iBAAQ,KAfa;AAgBrBC,mBAAU,KAhBW;AAiBrBC,oBAAW,IAjBU;AAkBrBC,qBAAY;AAlBS,OAAhB,CAAR;;AAqBA/F,YAAMgG,OAAN,CAAc,oBAAd,EAAoCN,QAApC,CAA6C,mBAA7C,EAAkEA,QAAlE,CAA2E,0BAA3E;;AAEA;AACA1F,YAAMiC,GAAN,GAAYgE,OAAZ,GAAsBC,KAAtB,CAA4B,YAAY;AACrC,aAAM3D,SAAS,IAAf;AACA,+BAAE,OAAF,EAAW,KAAK4D,MAAL,EAAX,EAA0BC,EAA1B,CAA6B,cAA7B,EAA6C,YAAY;AACtD,gBAAI7D,OAAO8D,MAAP,OAAoB,KAAKC,KAA7B,EACG/D,OAAO8D,MAAP,CAAc,KAAKC,KAAnB,EAA2BtC,IAA3B;AACL,UAHD;AAIF,OAND;;AASA/D,mBAAaF,UAAUwG,eAAV,CAA0B;AACpC9B,gBAAO,WAD6B;AAEpC+B,eAAM,IAF8B,EAExB;AACZC,kBAASvF,YAH2B;AAIpCwF,kBAASxF;AAJ2B,OAA1B,CAAb;;AAOAnB,gBAAUqG,EAAV,CAAa,OAAb,EAAsBO,cAAtB;AACA5G,gBAAU6G,MAAV,CAAiB,MAAjB;;AAGA;AACA1F,mBAAa,EAACmB,OAAM,IAAP,EAAb;AACAtC,gBAAU8G,MAAV,CAAiB,YAAM;AACpB,aAAMC,YAAY/G,UAAU+G,SAAV,EAAlB;AAAA,aACGC,cAAchH,UAAUgH,WAAV,EADjB;AAAA,aAEGC,eAAejH,UAAU,CAAV,EAAaiH,YAF/B;AAAA,aAGGC,UAAU,CAACH,YAAYC,WAAb,IAA4BC,YAHzC;AAIA,aAAGC,UAAU,IAAV,IAAkB,CAAClG,OAAnB,IAA8B,CAACC,sBAA/B,IAAyD,CAACC,kBAA7D,EAAgF;AAC7EC,yBAAa,EAACmB,OAAM,KAAP,EAAb;AACF;AACH,OARD;AAUF,IAnFD;;AAqFA,OAAMsE,iBAAiB,SAAjBA,cAAiB,CAACO,CAAD,EAAO;AAC3B,UAAMC,SAASD,EAAEC,MAAjB;AACA,UAAMC,UAAU,sBAAED,MAAF,CAAhB;AACA,UAAGA,OAAOE,OAAP,KAAmB,QAAnB,IAA+BD,QAAQE,QAAR,CAAiB,iBAAjB,CAAlC,EAAuE;AACvE,UAAMC,KAAKJ,OAAOK,aAAP,CAAqBA,aAAhC;AACA,UAAIC,cAAczH,MAAMiC,GAAN,GAAYyF,GAAZ,CAAgBH,EAAhB,EAAoB/E,IAApB,EAAlB;AACAiF,oBAAcjE,iBAAEmE,IAAF,CAAOF,WAAP,CAAd;AACAL,cAAQ1B,QAAR,CAAiB,iBAAjB;AACAkC,gCAAgB1H,IAAhB,CAAqBuH,YAAYI,WAAjC,EAA8CJ,YAAYlE,cAA1D,EACI/C,IADJ,CACS;AAAA,gBAAM4G,QAAQU,WAAR,CAAoB,iBAApB,CAAN;AAAA,OADT,EACuDpH,KADvD,CAC6D,UAACC,GAAD,EAAS;AAChEyG,iBAAQU,WAAR,CAAoB,iBAApB;AACA1D,0BAAEC,KAAF,CAAQxD,KAAR,CAAc,EAAEyD,SAAS3D,IAAI2D,OAAf,EAAd;AACF,OAJJ;AAKF,IAbD;;qBAegB,EAAEpE,UAAF,E","file":"statement.js","sourcesContent":["ï»¿/**\r\n * Created by amin on November 9, 2015.\r\n */\r\nimport $ from \"jquery\";\r\nimport windows from \"../windows/windows\";\r\nimport liveapi from \"../websockets/binary_websockets\";\r\nimport _ from \"lodash\";\r\nimport \"datatables\";\r\nimport \"jquery-growl\";\r\nimport 'css!./statement.css';\r\nimport html from 'text!./statement.html';\r\nimport viewTransaction from '../viewtransaction/viewTransaction';\r\n\r\nlet statement = null,\r\n   table = null,\r\n   datepicker = null;\r\n\r\nexport const init = ($menuLink) => {\r\n   $menuLink.click(() => {\r\n      if (!statement)\r\n         liveapi.cached.authorize()\r\n            .then(initStatement)\r\n            .catch(\r\n               (err) => console.error(err)\r\n            );\r\n      else\r\n         statement.moveToTop();\r\n   });\r\n};\r\n\r\nlet loading = false;\r\nlet is_specific_date_shown = false; /* is data for a specific date is shown */\r\nlet scroll_end_reached = false;\r\n\r\nconst refreshTable  = (yyy_mm_dd) => {\r\n   const processing_msg = $('#' + table.attr('id') + '_processing').css('top','200px').show();\r\n\r\n   const request = {\r\n      statement: 1,\r\n      description: 1\r\n   };\r\n\r\n   /* if a date is specified get the transactions for that date */\r\n   if (typeof yyy_mm_dd === 'string') {\r\n      request.date_from = yearMonthDayToEpoch(yyy_mm_dd, { utc: true });\r\n      const one_day_utc = Date.UTC(1970, 0, 1, 23, 59, 59) / 1000;\r\n      request.date_to = request.date_from + one_day_utc;\r\n      table.api().rows().remove();\r\n      is_specific_date_shown = true;\r\n   }\r\n   else  { /* request the next 50 items for live scroll */\r\n      request.limit = 250;\r\n      if (is_specific_date_shown || (yyy_mm_dd && yyy_mm_dd.clear)) {\r\n         table.api().rows().remove();\r\n         is_specific_date_shown = false;\r\n      }\r\n      request.offset = table.api().column(0).data().length;\r\n   }\r\n   \r\n   /* refresh the table with result of { profit_table:1 } from WS */\r\n   const refresh = (data) => {\r\n      const transactions = (data.statement && data.statement.transactions) || [];\r\n      const view_button_text = 'View'.i18n();\r\n      const rows = transactions.map((trans) => {\r\n         let class_name = _(['buy', 'sell']).includes(trans.action_type) ? '' : 'button-disabled';\r\n             class_name = _(['deposit', 'withdrawal']).includes(trans.action_type) ? 'invisible' : class_name;\r\n         const view_button = `<button class=\"${ class_name }\">${ view_button_text }</button>`;\r\n         const amount = trans.amount * 1;\r\n         return [\r\n            epochToString(trans.transaction_time, { utc: true }),\r\n            trans.transaction_id,\r\n            _.capitalize(trans.action_type),\r\n            trans.longcode,\r\n            trans.amount * 1,\r\n            '<b>' + formatPrice(trans.balance_after,local_storage.get(\"currency\")) + '</b>',\r\n            view_button,\r\n            trans, /* data for view transaction dailog - when clicking on arrows */\r\n         ];\r\n      });\r\n      table.api().rows.add(rows);\r\n      table.api().draw();\r\n      loading = false;\r\n      if (data.statement.count === 0) scroll_end_reached = true;\r\n      processing_msg.hide();\r\n   };\r\n\r\n   if(!loading) {\r\n         loading = true;\r\n         liveapi\r\n            .send(request)\r\n            .then(refresh)\r\n            .catch((err) => {\r\n                  refresh({});\r\n                  $.growl.error({ message: err.message });\r\n                  console.error(err);\r\n                  loading = false;\r\n            });\r\n   }\r\n}\r\n\r\nconst initStatement = () => {\r\n   scroll_end_reached = false;\r\n   statement = windows.createBlankWindow($('<div/>'), {\r\n      title: 'Statement'.i18n(),\r\n      dialogClass: 'statement',\r\n      width: 800 ,\r\n      height: 400,\r\n      close: () => {\r\n         table && table.DataTable().destroy(true);\r\n         statement && statement.remove();\r\n         statement = null;\r\n      },\r\n      refresh: () => {\r\n         datepicker.clear();\r\n         refreshTable({clear:true});\r\n      },\r\n      'data-authorized' :'true'\r\n   });\r\n   statement.track({\r\n      module_id: 'statement',\r\n      is_unique: true,\r\n      data: null,\r\n   });\r\n\r\n   table = $(html).i18n();\r\n   table.appendTo(statement);\r\n\r\n   table = table.dataTable({\r\n      data: [],\r\n      autoWidth: false,\r\n      \"columnDefs\": [ {\r\n         \"targets\": 3,\r\n         \"width\": \"35%\"\r\n      }, {\r\n         \"targets\": 4,\r\n         \"createdCell\": (td, cellData) => {\r\n            const css_class = (cellData < 0) ? 'red' : (cellData > 0) ? 'green' : 'bold';\r\n            if (css_class)\r\n               $(td).addClass(css_class);\r\n            td.innerHTML = formatPrice(cellData, local_storage.get(\"currency\"));\r\n         }\r\n      }],\r\n      paging: false,\r\n      ordering: false,\r\n      searching: true,\r\n      processing: true,\r\n   });\r\n\r\n   table.closest('.ui-dialog-content').addClass('hide-search-input').addClass('statement-dialog-content');\r\n\r\n   // Apply the a search on each column input change\r\n   table.api().columns().every(function () {\r\n      const column = this;\r\n      $('input', this.header()).on('keyup change', function () {\r\n         if (column.search() !== this.value)\r\n            column.search(this.value) .draw();\r\n      });\r\n   });\r\n\r\n\r\n   datepicker = statement.addDateToHeader({\r\n      title: 'Jump to: ',\r\n      date: null, /* set date to null */\r\n      changed: refreshTable,\r\n      cleared: refreshTable\r\n   });\r\n\r\n   statement.on('click', on_arrow_click);\r\n   statement.dialog('open');\r\n\r\n\r\n   /**************** infinite scroll implementation *******************/\r\n   refreshTable({clear:true});\r\n   statement.scroll(() => {\r\n      const scrollTop = statement.scrollTop(),\r\n         innerHeight = statement.innerHeight(),\r\n         scrollHeight = statement[0].scrollHeight,\r\n         postion = (scrollTop + innerHeight) / scrollHeight;\r\n      if(postion > 0.75 && !loading && !is_specific_date_shown && !scroll_end_reached){\r\n         refreshTable({clear:false});\r\n      }\r\n   });\r\n\r\n};\r\n\r\nconst on_arrow_click = (e) => {\r\n   const target = e.target;\r\n   const $target = $(target);\r\n   if(target.tagName !== 'BUTTON' || $target.hasClass('button-disabled')) return;\r\n   const tr = target.parentElement.parentElement;\r\n   let transaction = table.api().row(tr).data();\r\n   transaction = _.last(transaction);\r\n   $target.addClass('button-disabled');\r\n   viewTransaction.init(transaction.contract_id, transaction.transaction_id)\r\n      .then(() => $target.removeClass('button-disabled')).catch((err) => {\r\n         $target.removeClass('button-disabled');\r\n         $.growl.error({ message: err.message });\r\n      });\r\n}\r\n\r\nexport default  { init }\r\n"]}