{"version":3,"sources":["../../../../src/historical-data/historical-data.es6"],"names":["dialog","buildMenu","$root","instrumentName","callback","markets","length","_","delay","menu","map","m","display_name","submarkets","s","instruments","i","symbol","join","$menu","find","on","e","a","target","text","closest","attr","titlebar","append","buildDatetime","datetime","datepicker","changeMonth","numberOfMonths","changeYear","dateFormat","onSelect","change","update_time","beforeShow","input","inst","dpDiv","css","marginLeft","top","offset","left","zIndex","minDate","moment","utc","subtract","toDate","maxDate","timepicker","showCloseButton","tpDiv","marginTop","date","val","time","result","unix","createWindow","options","options_copy","html","$","extend","title","i18n","relativePosition","dialogClass","close","chart","actions","destroy","remove","resize","reflow","width","height","open","parent","promise","done","windows","createBlankWindow","show_chart","WebtraderCharts","chartWindow","addNewChart","events","anyChange","data","instrumentCode","start","update_track","track","module_id","is_unique","init","$menuLink","click","moveToTop","timePeriod","type","showInstrumentName","showOverlays","indicators","overlays","startOf"],"mappings":"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","file":"historical-data.js","sourcesContent":["import $ from 'jquery';\r\nimport windows from '../windows/windows';\r\nimport liveapi from '../websockets/binary_websockets';\r\nimport moment from 'moment';\r\nimport 'timepicker';\r\nimport 'highstock-release/modules/offline-exporting';\r\nimport 'common/util';\r\nimport 'webtrader-charts';\r\nimport html from 'text!./historical-data.html';\r\nimport _ from 'lodash';\r\nimport 'jquery-ui';\r\nimport 'css!./historical-data.css';\r\nimport {getMarketData} from '../instruments/instruments';\r\n\r\nlet dialog = null;\r\n\r\nconst buildMenu = ($root, instrumentName, callback) => {\r\n   const markets = getMarketData();\r\n   if(!markets || !markets.length){\r\n      _.delay(() => buildMenu($root, instrumentName, callback), 1000);\r\n      return;\r\n   }\r\n   const menu = `<ul>${\r\n      markets.map(m => `<li><div>${m.display_name}</div><ul>${\r\n         m.submarkets.map(s => `<li><div>${s.display_name}</div><ul>${\r\n            s.instruments.map(i => `<li symbol='${i.symbol}'><div>${i.display_name}</div></li>`).join('')\r\n         }</ul></li>`).join('')\r\n      }</ul></li>`).join('')\r\n   }</ul>`;\r\n   const $menu = $(menu);\r\n   $menu.find('li[symbol]').on('click', (e,a) => {\r\n      const display_name = $(e.target).text();\r\n      const symbol = $(e.target).closest('li').attr('symbol');\r\n      titlebar.find('.title').text(display_name);\r\n      callback(symbol, display_name);\r\n   });\r\n   const titlebar = $(`<div class='instrument-dropdown' ><div class='title'>${instrumentName}</div>`);\r\n   $root.closest('.ui-dialog').append(titlebar);\r\n   titlebar.append($menu);\r\n   $menu.menu();\r\n};\r\n\r\nconst buildDatetime = (dialog, $root, callback) => {\r\n    const datetime = $(`<div class='date-time'>\r\n                    <input type=\"text\" class=\"date\" tab-index=\"-1\" readonly></input>\r\n                    <input type=\"text\" class=\"time\" tab-index=\"-1\" value=\"00:00\" readonly></input>\r\n          </div>`);\r\n    $root.closest('.ui-dialog').append(datetime);\r\n    datetime.find('.date')\r\n       .datepicker({\r\n             changeMonth : true,\r\n             // showAnim: 'drop',\r\n             numberOfMonths: 1,\r\n             changeYear : true,\r\n             dateFormat : 'yy-mm-dd',\r\n             onSelect: function () { $(this).change(); update_time(); },\r\n             beforeShow: (input, inst) => {\r\n                _.delay(() => inst.dpDiv.css({\r\n                   marginLeft: '-60px',\r\n                   top: datetime.find('.date').offset().top + 32,\r\n                   left: datetime.find('.date').offset().left,\r\n                   zIndex: dialog.closest('.ui-dialog').css('z-index')*1 + 100\r\n                }));\r\n             },\r\n             minDate : moment.utc().subtract(1, 'years').toDate(),\r\n             maxDate : moment.utc().toDate(),\r\n         })\r\n         .datepicker('setDate', '0');\r\n\r\n     datetime.find('.time')\r\n         .timepicker({\r\n            showCloseButton : false,\r\n            beforeShow: (input, inst) => inst.tpDiv.css({\r\n                marginLeft: '-120px',\r\n                marginTop: '6px',\r\n                zIndex: 101,\r\n            }),\r\n            onSelect: function() { $(this).change(); update_time(); },\r\n         });\r\n    const update_time = () => {\r\n       const date = datetime.find('.date').val();\r\n       const time = datetime.find('.time').val();\r\n       const result = moment(`${date} ${time} +0000`, 'YYYY-MM-DD HH:mm Z').unix()*1;\r\n       callback && callback(result);\r\n    };\r\n};\r\nexport const createWindow = function(options) {\r\n    let options_copy = options;\r\n    const $root = $(html);\r\n    options = $.extend({\r\n        title: 'Historical Data For'.i18n(),\r\n        relativePosition: true,\r\n        dialogClass: 'historical-data-dialog',\r\n        close: function() {\r\n            chart.actions.destroy();\r\n            $(this).dialog('destroy').remove(); //completely remove this dialog\r\n            dialog = null;\r\n        },\r\n        resize: () => chart && chart.actions.reflow(),\r\n        width: 700,\r\n        height: 400,\r\n        open: function() {\r\n            const dialog = $(this);\r\n            $(this).parent().promise().done(() => chart.actions.reflow());\r\n        }\r\n    }, options);\r\n\r\n    dialog = windows.createBlankWindow($root, options);\r\n\r\n    let chart = null;\r\n    const show_chart = () => {\r\n       chart && chart.actions.destroy(); chart = null;\r\n       chart = WebtraderCharts.chartWindow.addNewChart($root, options_copy);\r\n       chart.actions.reflow();\r\n       chart.events.anyChange = () => {\r\n          options_copy = chart.data();\r\n       };\r\n    };\r\n    show_chart();\r\n\r\n    buildMenu($root, options_copy.instrumentName, (symbol, display_name) => {\r\n       options_copy.instrumentName = display_name;\r\n       options_copy.instrumentCode = symbol;\r\n       show_chart();\r\n    });\r\n    buildDatetime(dialog, $root, (start) => {\r\n       options_copy.start = start;\r\n       show_chart();\r\n    });\r\n \r\n    const update_track = dialog.track({\r\n        module_id: 'historicalData',\r\n        is_unique: true,\r\n        data: null\r\n    });\r\n\r\n    dialog.dialog('open');\r\n\r\n    return dialog;\r\n};\r\n\r\nexport const init = $menuLink => {\r\n   $menuLink.click(() => {\r\n      dialog && dialog.moveToTop() || createWindow({\r\n         instrumentCode: 'frxAUDJPY',\r\n         instrumentName: 'AUD/JPY',\r\n         timePeriod: '1d',\r\n         type: 'candlestick',\r\n         showInstrumentName: true,\r\n         showOverlays: false,\r\n         indicators: [],\r\n         overlays: [],\r\n         start: moment.utc().subtract(1, \"years\").startOf('day').unix()*1,\r\n      });\r\n   });\r\n};\r\n\r\nexport default { init };\r\n"]}