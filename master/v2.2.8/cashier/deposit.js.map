{"version":3,"sources":["../../../../src/cashier/deposit.es6"],"names":["init","require","deposit_win","deposit_win_view","error_handler","err","console","error","$","growl","message","li","click","liveapi","cached","authorize","then","init_deposit_win","html","catch","moveToTop","root","i18n","windows","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","height","close","trigger","remove","open","destroy","unbind","init_state","dialog","offset","top","my","left","at","css","track","module_id","is_unique","state","route","value","empty_fields","validate","clear","_","debounce","show","user","currency","local_storage","get","email","cashier_url","residence","residence_name","is_cryptocurrency","isCryptoCurrency","standard_methods","iframe_visible","payment_agents","list","current","binary_url","getBinaryUrl","update","iframe_loaded","get_commission_text","agent","deposit_commission","withdrawal_commission","onclick","e","elem","target","next","cur_elem","is_active","scrollHeight","rv","bind","send","cashier","data","code","tncApprovalWin","init_win","error_text","residence_promise","get_settings","country_code","country","paymentagent_list","pa_list","map","commission_text","supported_banks","toLowerCase","split"],"mappings":"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","file":"deposit.js","sourcesContent":["/*\r\n * Created by amin on June 26, 2016.\r\n */\r\n\r\nimport $ from 'jquery';\r\nimport liveapi from 'websockets/binary_websockets';\r\nimport windows from 'windows/windows';\r\nimport rv from 'common/rivetsExtra';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport tncApprovalWin from \"cashier/uk_funds_protection\"\r\nimport html from 'text!cashier/deposit.html';\r\nimport '../common/util';\r\n\r\nrequire(['text!cashier/deposit.html']);\r\nrequire(['css!cashier/deposit.css']);\r\nlet deposit_win = null;\r\nlet deposit_win_view = null; // rivets view\r\n\r\nconst error_handler = function(err) {\r\n    console.error(err);\r\n    $.growl.error({ message: err.message });\r\n};\r\n\r\nexport function init(li) {\r\n    li.click(() => {\r\n        if (!deposit_win) {\r\n            liveapi.cached.authorize().then(() => {\r\n                init_deposit_win(html);\r\n            }).catch(error_handler);\r\n        } else\r\n            deposit_win.moveToTop();\r\n    });\r\n}\r\n\r\nfunction init_deposit_win(root) {\r\n    root = $(root).i18n();\r\n    deposit_win = windows.createBlankWindow(root, {\r\n        title: 'Deposit funds',\r\n        resizable: true,\r\n        collapsable: false,\r\n        minimizable: true,\r\n        maximizable: true,\r\n        width: 700,\r\n        height: 600,\r\n        'data-authorized': true,\r\n        close: function() {\r\n            deposit_win.trigger('dialogclose'); // TODO: figure out why event is not fired.\r\n            deposit_win.remove();\r\n            deposit_win = null;\r\n        },\r\n        open: function() {},\r\n        destroy: function() {\r\n            deposit_win_view && deposit_win_view.unbind();\r\n            deposit_win_view = null;\r\n        }\r\n    });\r\n\r\n    init_state(root);\r\n    deposit_win.dialog('open');\r\n\r\n    /* update dialog position, this way when dialog is resized it will not move*/\r\n    var offset = deposit_win.dialog('widget').offset();\r\n    offset.top = 110;\r\n    deposit_win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\r\n    deposit_win.dialog('widget').css({\r\n        left: offset.left + 'px',\r\n        top: offset.top + 'px'\r\n    });\r\n    deposit_win.track({\r\n        module_id: 'deposit',\r\n        is_unique: true\r\n    });\r\n}\r\n\r\nfunction init_state(root) {\r\n    var state = {\r\n        route: { value: 'standard-methods' },\r\n        empty_fields: {\r\n            validate: false,\r\n            clear: _.debounce(function() {\r\n                state.empty_fields.validate = false;\r\n            }, 4000),\r\n            show: function() {\r\n                state.empty_fields.validate = true;\r\n                state.empty_fields.clear();\r\n            }\r\n        },\r\n        user: {\r\n            currency: local_storage.get('currency'),\r\n            email: local_storage.get('authorize').email,\r\n            cashier_url: '',\r\n            residence: '',\r\n            residence_name: ''\r\n        },\r\n        is_cryptocurrency: isCryptoCurrency(),\r\n        standard_methods: {\r\n            iframe_visible: false,\r\n        },\r\n        payment_agents: {\r\n            list: [],\r\n            current: {},\r\n        },\r\n        binary_url: getBinaryUrl('payment-agent.html'),\r\n    };\r\n\r\n    state.route.update = route => { state.route.value = route; };\r\n\r\n    state.standard_methods.iframe_loaded = function() {\r\n        if (state.user.cashier_url)\r\n            state.standard_methods.iframe_visible = true;\r\n    }\r\n\r\n    state.payment_agents.get_commission_text = function(agent) {\r\n        if (agent.deposit_commission === agent.withdrawal_commission) {\r\n            return agent.deposit_commission + '% ' + 'commission'.i18n();\r\n        }\r\n        return agent.deposit_commission + '% ' + 'deposits'.i18n() + ' / ' +\r\n            agent.withdrawal_commission + '% ' + 'withdrawals'.i18n();\r\n    }\r\n    state.payment_agents.onclick = function(agent, e) {\r\n        var elem = $(e.target).next();\r\n        var cur_elem = state.payment_agents.elem;\r\n        cur_elem && cur_elem.css('max-height', '0');\r\n        state.payment_agents.current.is_active = false;\r\n        if (state.payment_agents.current === agent) {\r\n            state.payment_agents.current = {};\r\n        } else {\r\n            state.payment_agents.current = agent;\r\n            state.payment_agents.elem = elem;\r\n            elem.css('max-height', elem[0].scrollHeight + 'px');\r\n            agent.is_active = true;\r\n        }\r\n    }\r\n\r\n    deposit_win_view = rv.bind(root[0], state);\r\n\r\n    /* get the cashier_url */\r\n    liveapi.send({\r\n        cashier: 'deposit'\r\n    }).then(function(data) {\r\n        state.user.cashier_url = data.cashier;\r\n    }).catch((err) => {\r\n        if (err.code === \"ASK_UK_FUNDS_PROTECTION\") {\r\n            deposit_win.dialog(\"close\");\r\n            tncApprovalWin.init_win().then(() => {\r\n                init_deposit_win(html);\r\n            }).catch(err => {\r\n                error_handler(err);\r\n            });\r\n            return;\r\n        }\r\n        state.error_text = err.message;\r\n    });\r\n\r\n    /* get the residence field and its states */\r\n    var residence_promise = liveapi.cached.send({ get_settings: 1 })\r\n        .then(function(data) {\r\n            state.user.residence = data.get_settings.country_code;\r\n            state.user.residence_name = data.get_settings.country;\r\n        })\r\n        .catch(error_handler);\r\n\r\n    /* get payment agents list */\r\n    residence_promise.then(function() {\r\n        if (!state.user.residence)\r\n            return { paymentagent_list: { list: [] } };\r\n        return liveapi.send({ paymentagent_list: state.user.residence, currency: state.user.currency });\r\n    }).then((data) => {\r\n        const pa_list = data.paymentagent_list.list\r\n            .map((agent) => {\r\n                agent.commission_text = state.payment_agents.get_commission_text(agent);\r\n                agent.supported_banks = agent.supported_banks.toLowerCase().split(',');\r\n                return agent;\r\n            });\r\n        state.payment_agents.list = pa_list;\r\n    }).catch(error_handler);\r\n}\r\n\r\nexport default {\r\n    init: init\r\n}\r\n"]}