{"version":3,"sources":["../../../../src/profittable/profitTable.es6"],"names":["profitWin","table","datepicker","init","$menuLink","click","liveapi","cached","authorize","then","initProfitWin","catch","err","console","error","$","growl","message","moveToTop","loading","options","offset","limit","is_specific_date_shown","refreshTable","yyyy_mm_dd","processing_msg","attr","css","show","request","profit_table","description","sort","date_from","yearMonthDayToEpoch","utc","one_day_utc","Date","UTC","date_to","api","rows","remove","clear","column","data","length","refresh","transactions","map","trans","profit","parseFloat","sell_price","buy_price","toFixed","currencyFractionalDigits","view_button","i18n","longcode","log","epochToString","purchase_time","transaction_id","formatPrice","local_storage","get","sell_time","add","draw","hide","send","on_arrow_click","e","target","$target","tagName","hasClass","tr","parentElement","transaction","row","_","last","addClass","viewTransaction","contract_id","removeClass","windows","createBlankWindow","title","dialogClass","width","height","destroy","DataTable","track","module_id","is_unique","html","appendTo","footer","dataTable","columnDefs","targets","createdCell","td","cellData","css_class","innerHTML","info","footerCallback","start","end","display","total","reduce","a","b","paging","ordering","searching","processing","parent","columns","every","header","on","search","value","addDateToHeader","date","changed","cleared","dialog","scroll","scrollTop","innerHeight","scrollHeight","postion"],"mappings":"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","file":"profitTable.js","sourcesContent":["ï»¿/**\r\n * Created by amin on October 29, 2015.\r\n */\r\nimport $ from  \"jquery\";\r\nimport _ from \"lodash\";\r\nimport windows from \"../windows/windows\";\r\nimport liveapi from \"../websockets/binary_websockets\";\r\nimport viewTransaction from '../viewtransaction/viewTransaction';\r\nimport \"datatables\";\r\nimport \"jquery-growl\";\r\nimport '../common/util';\r\nimport \"css!./profitTable.css\";\r\nimport html from 'text!./profitTable.html';\r\n\r\nlet profitWin = null,\r\n   table = null,\r\n   datepicker = null;\r\n\r\nexport const init = ($menuLink) => {\r\n   $menuLink.click(() => {\r\n      if (!profitWin)\r\n         liveapi.cached.authorize()\r\n            .then(initProfitWin)\r\n            .catch((err) => {\r\n               console.error(err);\r\n               $.growl.error({ message: err.message });\r\n            });\r\n      else{       \r\n         profitWin.moveToTop();\r\n      }\r\n   });\r\n}\r\n\r\nlet loading = false;\r\nconst options = { offset : 0, limit: 200 };\r\nlet is_specific_date_shown = false; /* is data for a specific date is shown */\r\n\r\nconst refreshTable = (yyyy_mm_dd) => {\r\n   const processing_msg = $('#' + table.attr('id') + '_processing').css('top','200px').show();\r\n   loading = true;\r\n\r\n   const request = {\r\n      profit_table: 1,\r\n      description: 1,\r\n      sort: 'DESC'\r\n   };\r\n\r\n   /* if a date is specified get the transactions for that date */\r\n   if (typeof yyyy_mm_dd === 'string') {\r\n      request.date_from = yearMonthDayToEpoch(yyyy_mm_dd, { utc: true });\r\n      const one_day_utc = Date.UTC(1970, 0, 1, 23, 59, 59) / 1000;\r\n      request.date_to = request.date_from + one_day_utc;\r\n      table.api().rows().remove();\r\n      is_specific_date_shown = true;\r\n   }\r\n   else  { /* request the next 50 items for live scroll */\r\n      request.limit = 250;\r\n      if(is_specific_date_shown || yyyy_mm_dd.clear) {\r\n         table.api().rows().remove();\r\n         is_specific_date_shown = false;\r\n      }\r\n      request.offset = table.api().column(0).data().length;\r\n   }\r\n\r\n   /* refresh the table with result of { profit_table:1 } from WS */\r\n   const refresh = (data) => {\r\n      const transactions = (data.profit_table && data.profit_table.transactions) || [];\r\n      const rows = transactions.map((trans) => {\r\n         const profit = (parseFloat(trans.sell_price) - parseFloat(trans.buy_price)).toFixed(currencyFractionalDigits()); //= parseFloat(trans.sell_price) - parseFloat(trans.buy_price)\r\n         const view_button = '<button>View</button>'.i18n();\r\n         try{\r\n            trans.longcode;            \r\n         }catch(err){\r\n            console.log(trans);\r\n         }\r\n         return [\r\n            epochToString(trans.purchase_time, { utc: true }),\r\n            trans.transaction_id,\r\n            trans.longcode,\r\n            formatPrice(trans.buy_price,local_storage.get(\"currency\")),\r\n            epochToString(trans.sell_time, { utc: true }),\r\n            formatPrice(trans.sell_price,local_storage.get(\"currency\")),\r\n            profit,\r\n            view_button,\r\n            trans, /* we will use it when handling arrow clicks to show view transaction dialog */\r\n         ];\r\n      });\r\n      table.api().rows.add(rows);\r\n      table.api().draw();\r\n      loading = false;\r\n      processing_msg.hide();\r\n   };\r\n\r\n   liveapi.send(request)\r\n      .then(refresh)\r\n      .catch((err) => {\r\n         refresh({});\r\n         $.growl.error({ message: err.message });\r\n         console.error(err);\r\n      });\r\n}\r\n\r\nconst on_arrow_click = (e) =>{\r\n   const target = e.target;\r\n   const $target = $(target);\r\n   if(target.tagName !== 'BUTTON' || $target.hasClass('button-disabled')) return;\r\n   const tr = target.parentElement.parentElement;\r\n   let transaction = table.api().row(tr).data();\r\n   transaction = _.last(transaction);\r\n   $target.addClass('button-disabled');\r\n   viewTransaction.init(transaction.contract_id, transaction.transaction_id)\r\n      .then(() => $target.removeClass('button-disabled'))\r\n      .catch(err => {\r\n         $target.removeClass('button-disabled');\r\n         $.growl.error({ message: err.message });\r\n      });\r\n}\r\n\r\nconst initProfitWin = () => {\r\n   profitWin = windows.createBlankWindow($('<div/>'), {\r\n      title: 'Profit Table'.i18n(),\r\n      dialogClass: 'profitTable',\r\n      width: 800 ,\r\n      height: 400,\r\n      destroy: () => {\r\n         table && table.DataTable().destroy(true);\r\n         profitWin = null;\r\n      },\r\n      refresh: () => {\r\n         datepicker.clear();\r\n         refreshTable({clear:true});\r\n      },\r\n      'data-authorized': 'true'\r\n   });\r\n   profitWin.track({\r\n      module_id: 'profitTable',\r\n      is_unique: true,\r\n      data: null\r\n   });\r\n\r\n   table = $(html).i18n();\r\n   table.appendTo(profitWin);\r\n   const footer = $('<div/>').addClass('profit-table-info');\r\n\r\n   table = table.dataTable({\r\n      data: [],\r\n      columnDefs: [ {\r\n         targets: 6,\r\n         createdCell: (td, cellData) => {\r\n            const css_class = (cellData < 0) ? 'red' : (cellData > 0) ? 'green' : 'bold';\r\n            if (css_class)\r\n               $(td).addClass(css_class);\r\n            $(td).attr(\"data-src\", cellData);\r\n            td.innerHTML = formatPrice(cellData,local_storage.get(\"currency\"));\r\n         }\r\n      }],\r\n      info: false,\r\n      footerCallback: function ( row, data, start, end, display ) {\r\n         const api = this.api();\r\n\r\n         const total = api.column(6).data()\r\n            .reduce((a, b) => (a*1 + b*1), 0);\r\n\r\n         const css = 'total ' + (total >= 0 ? 'green' : 'red');\r\n         footer.html(\r\n            '<span class=\"title\">Total Profit/Loss<span>' +\r\n            '<span class=\"' + css + '\">'+ formatPrice(total,local_storage.get(\"currency\")) +'</span>'\r\n         );\r\n      },\r\n      paging: false,\r\n      ordering: false,\r\n      searching: true,\r\n      processing: true\r\n   });\r\n   footer.i18n().appendTo(table.parent());\r\n   table.parent().addClass('hide-search-input');\r\n\r\n   // Apply the a search on each column input change\r\n   table.api().columns().every(function () {\r\n      const column = this;\r\n      $('input', this.header()).on('keyup change', function () {\r\n         if (column.search() !== this.value)\r\n            column.search(this.value) .draw();\r\n      });\r\n   });\r\n\r\n   refreshTable({clear: true});\r\n   datepicker = profitWin.addDateToHeader({\r\n      title: 'Jump to: '.i18n(),\r\n      date: null, /* set date to null */\r\n      changed: refreshTable,\r\n      cleared: refreshTable\r\n   });\r\n\r\n   profitWin.dialog('open');\r\n   profitWin.on('click', on_arrow_click);\r\n\r\n   /**************** infinite scroll implementation *******************/\r\n   profitWin.scroll(() => {\r\n      const scrollTop = profitWin.scrollTop(),\r\n         innerHeight = profitWin.innerHeight(),\r\n         scrollHeight = profitWin[0].scrollHeight,\r\n         postion = (scrollTop + innerHeight) / scrollHeight;\r\n      if(postion > 0.75 && !loading && !is_specific_date_shown){\r\n         refreshTable({clear:false});\r\n      }\r\n   });\r\n}\r\n\r\nexport default { init }\r\n"]}